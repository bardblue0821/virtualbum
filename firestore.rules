rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    function isSignedIn() {
      return request.auth != null;
    }

    function isUser(uid) {
      return isSignedIn() && request.auth.uid == uid;
    }

    function isAdmin() {
      return isSignedIn() && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.isAdmin == true;
    }

    // フレンド関係およびアルバム可視性の簡易チェック
    function isFriendWith(otherId) {
      return isSignedIn() && (
        get(/databases/$(database)/documents/friends/$(request.auth.uid + '_' + otherId)).data.status == 'accepted' ||
        get(/databases/$(database)/documents/friends/$(otherId + '_' + request.auth.uid)).data.status == 'accepted'
      );
    }

    // ブロック判定: 自分がotherIdをブロックしているか
    function isBlocking(otherId) {
      return isSignedIn() && 
        exists(/databases/$(database)/documents/users/$(request.auth.uid)/blockedUsers/$(otherId));
    }

    // ブロック判定: otherIdが自分をブロックしているか
    function isBlockedBy(otherId) {
      return isSignedIn() && 
        exists(/databases/$(database)/documents/users/$(otherId)/blockedUsers/$(request.auth.uid));
    }

    // 双方向ブロック判定: どちらかがブロックしているか
    function isEitherBlocking(otherId) {
      return isBlocking(otherId) || isBlockedBy(otherId);
    }

    // friends 限定アルバムの場合は、オーナーまたはフレンドのみを「可視」とみなす
    function canReadAlbum(albumId) {
      let a = get(/databases/$(database)/documents/albums/$(albumId)).data;
      return (
        a.visibility != 'friends' ||
        (isSignedIn() && (a.ownerId == request.auth.uid || isFriendWith(a.ownerId)))
      );
    }

    // users/{uid}
    match /users/{uid} {
      allow read: if true;
      allow create: if isUser(uid);
      allow update, delete: if isUser(uid);
    }
    
    // reactions/{rid} （ID = albumId:userId:emoji）
    match /reactions/{rid} {
      allow read: if true;
      allow create: if isSignedIn()
        && request.resource.data.userId == request.auth.uid
        && rid == request.resource.data.albumId + ':' + request.resource.data.userId + ':' + request.resource.data.emoji
        && request.resource.data.keys().hasAll(['albumId','userId','emoji','createdAt'])
        && canReadAlbum(request.resource.data.albumId)
        && !isBlockedBy(get(/databases/$(database)/documents/albums/$(request.resource.data.albumId)).data.ownerId);
      allow delete: if isSignedIn() && resource.data.userId == request.auth.uid;
      allow update: if false;
    }

    // albums/{albumId}
    match /albums/{albumId} {
      allow read: if true;
      // アルバム作成: オーナーのみ可能
      // 注意: Firestore Rules では画像の存在をチェックできないため、
      // アプリケーション側で少なくとも1枚の画像がある場合のみ作成するよう制御する
      allow create: if isSignedIn()
        && request.resource.data.ownerId == request.auth.uid;
      allow update: if isSignedIn()
        && resource.data.ownerId == request.auth.uid
        && request.resource.data.ownerId == resource.data.ownerId
        && request.resource.data.createdAt == resource.data.createdAt;
      // アルバム削除: オーナーのみ可能
      allow delete: if isSignedIn() && resource.data.ownerId == request.auth.uid;
    }

    // albumImages/{imageId}
    match /albumImages/{imageId} {
      allow read: if true;
      allow create: if isSignedIn()
        && request.resource.data.keys().hasAll(['albumId','uploaderId','url'])
        && request.resource.data.uploaderId == request.auth.uid
        && canReadAlbum(request.resource.data.albumId);
      // 画像削除: アップロード者本人またはアルバムオーナーのみ可能
      // 注意: Firestore Rules では「アルバムに残る画像数」を効率的にカウントできないため、
      // アプリケーション側で最後の1枚を削除しようとした場合にアルバムごと削除するよう制御する
      allow delete: if isSignedIn()
        && (
          resource.data.uploaderId == request.auth.uid ||
          get(/databases/$(database)/documents/albums/$(resource.data.albumId)).data.ownerId == request.auth.uid
        );
      allow update: if isSignedIn()
        && resource.data.uploaderId == request.auth.uid
        && request.resource.data.keys().hasAll(['albumId','uploaderId','url','id'])
        && request.resource.data.keys().hasOnly(['albumId','uploaderId','url','id','createdAt'])
        && request.resource.data.albumId == resource.data.albumId
        && request.resource.data.uploaderId == resource.data.uploaderId
        && request.resource.data.url == resource.data.url;
    }

    // comments/{commentId}
    match /comments/{commentId} {
      allow read: if true;
      allow create: if isSignedIn()
        && request.resource.data.userId == request.auth.uid
        && request.resource.data.body is string
        && request.resource.data.body.size() <= 200
        && request.resource.data.keys().hasAll(['albumId','userId','body','createdAt'])
        && canReadAlbum(request.resource.data.albumId)
        && !isBlockedBy(get(/databases/$(database)/documents/albums/$(request.resource.data.albumId)).data.ownerId);
      allow update: if isSignedIn()
        && resource.data.userId == request.auth.uid
        && request.resource.data.keys().hasOnly(['albumId','userId','body','createdAt','id'])
        && request.resource.data.albumId == resource.data.albumId
        && request.resource.data.userId == resource.data.userId
        && request.resource.data.createdAt == resource.data.createdAt;
      allow delete: if isSignedIn()
        && (
          resource.data.userId == request.auth.uid ||
          get(/databases/$(database)/documents/albums/$(resource.data.albumId)).data.ownerId == request.auth.uid
        );
    }

    // likes/{likeId} （ID = albumId_userId）
    match /likes/{likeId} {
      allow read: if true;
      allow create: if isSignedIn()
        && request.resource.data.userId == request.auth.uid
        && likeId == request.resource.data.albumId + '_' + request.resource.data.userId
        && request.resource.data.keys().hasAll(['albumId','userId','createdAt'])
        && canReadAlbum(request.resource.data.albumId)
        && !isBlockedBy(get(/databases/$(database)/documents/albums/$(request.resource.data.albumId)).data.ownerId);
      allow delete: if isSignedIn() && resource.data.userId == request.auth.uid;
      allow update: if false;
    }
    
    // reposts/{repostId} （ID = albumId_userId）
    match /reposts/{repostId} {
      allow read: if true;
      allow create: if isSignedIn()
        && request.resource.data.userId == request.auth.uid
        && repostId == request.resource.data.albumId + '_' + request.resource.data.userId
        && request.resource.data.keys().hasAll(['albumId','userId','createdAt'])
        && canReadAlbum(request.resource.data.albumId)
        && !isBlockedBy(get(/databases/$(database)/documents/albums/$(request.resource.data.albumId)).data.ownerId);
      allow delete: if isSignedIn() && resource.data.userId == request.auth.uid;
      allow update: if false;
    }

    // friends/{relationId} （ID = userId_targetId）
    match /friends/{relationId} {
      allow read: if isSignedIn();
      allow create: if isSignedIn()
        && request.resource.data.userId == request.auth.uid
        && relationId == request.resource.data.userId + '_' + request.resource.data.targetId
        && request.resource.data.status == 'pending'
        && request.resource.data.keys().hasAll(['id','userId','targetId','status','createdAt'])
        && !isEitherBlocking(request.resource.data.targetId);
      allow update: if isSignedIn()
        && resource.data.targetId == request.auth.uid
        && resource.data.status == 'pending'
        && request.resource.data.status == 'accepted';
      allow delete: if isSignedIn() && (resource.data.userId == request.auth.uid || resource.data.targetId == request.auth.uid);
    }

    // watches/{watchId} （ID = userId_ownerId）
    match /watches/{watchId} {
      allow read: if isSignedIn();
      allow create: if isSignedIn()
        && request.resource.data.userId == request.auth.uid
        && watchId == request.resource.data.userId + '_' + request.resource.data.ownerId
        && request.resource.data.keys().hasAll(['id','userId','ownerId','createdAt'])
        && !isBlockedBy(request.resource.data.ownerId);
      allow delete: if isSignedIn() && resource.data.userId == request.auth.uid;
      allow update: if false;
    }

    // blockedUsers/{blockedId} （ユーザーのブロックリスト）
    match /users/{userId}/blockedUsers/{blockedId} {
      // 本人のみ読み書き可能
      allow read: if isUser(userId);
      allow create: if isUser(userId)
        && request.resource.data.keys().hasAll(['id','blockedAt'])
        && request.resource.data.id == blockedId;
      allow delete: if isUser(userId);
      allow update: if false;
    }
    
    
    // notifications/{nid}
    match /notifications/{nid} {
      allow read: if isSignedIn() && resource.data.userId == request.auth.uid;
      allow create: if isSignedIn()
        && request.resource.data.actorId == request.auth.uid
        && request.resource.data.keys().hasAll(['userId','actorId','type','message','createdAt','readAt'])
        && request.resource.data.readAt == null
        && request.resource.data.type in ['comment','like','image','friend_request','watch','repost','reaction'];
      allow update: if isSignedIn()
        && resource.data.userId == request.auth.uid
        && request.resource.data.keys().hasOnly(['userId','actorId','type','message','createdAt','readAt','albumId','imageId','commentId','friendRequestId','watchId','id'])
        && request.resource.data.userId == resource.data.userId
        && request.resource.data.actorId == resource.data.actorId
        && request.resource.data.type == resource.data.type
        && request.resource.data.message == resource.data.message
        && request.resource.data.createdAt == resource.data.createdAt
        && resource.data.readAt == null
        && request.resource.data.readAt != null;
      allow delete: if false; 
    }

    // その他のパスは閉じる
    match /{document=**} {
      allow read, write: if false;
    }

    // rateLimits/{userId}/actions/{action}
    match /rateLimits/{userId}/actions/{action} {
      // 本人または管理者のみが読み取り可能
      allow read: if isUser(userId) || isAdmin();
      // Cloud Functionsからのみ書き込み可能（request.authがnullの場合はサーバー側からのアクセス）
      allow write: if false;
    }
  }
}
