# 検索機能 テスト仕様書

## テスト対象
- ユーザー検索（表示名・ユーザーID）
- 検索結果の表示
- 検索履歴
- フィルタリング

---

## 1. ユーザー検索機能

### 1.1 基本検索のテスト

#### テストケース 1.1.1: 表示名での検索
**前提条件:**
- ユーザー "John Doe" (handle: johndoe) が存在

**テスト手順:**
1. 検索欄に "John" を入力
2. 検索ボタンをクリック

**期待結果:**
- "John Doe" がヒットする
- 検索結果にアイコン、表示名、ユーザーIDが表示される

#### テストケース 1.1.2: ユーザーIDでの検索
**前提条件:**
- ユーザー "Jane Smith" (handle: janesmith) が存在

**テスト手順:**
1. 検索欄に "janesmith" を入力
2. 検索

**期待結果:**
- "Jane Smith" がヒットする

#### テストケース 1.1.3: 部分一致検索
**前提条件:**
- ユーザー "Alice", "Alicia", "Alex" が存在

**テスト手順:**
1. 検索欄に "Ali" を入力

**期待結果:**
- "Alice" と "Alicia" がヒット
- "Alex" はヒットしない（前方一致の場合）

#### テストケース 1.1.4: 大文字小文字を区別しない検索
**テスト手順:**
1. 検索欄に "JOHN" を入力

**期待結果:**
- "John Doe" がヒット
- 大文字小文字は区別されない

---

### 1.2 検索結果表示のテスト

#### テストケース 1.2.1: 複数結果の表示
**前提条件:**
- "test" を含むユーザーが30人存在

**テスト手順:**
1. "test" で検索

**期待結果:**
- 最大20件の結果が表示される
- ページネーションまたは「もっと見る」ボタンが表示される

#### テストケース 1.2.2: 結果0件の表示
**テスト手順:**
1. 存在しないユーザー名で検索

**期待結果:**
- 「該当するユーザーが見つかりませんでした」メッセージ
- 検索条件を変更する提案

#### テストケース 1.2.3: 検索結果からプロフィールへの遷移
**テスト手順:**
1. 検索結果のユーザーをクリック

**期待結果:**
- そのユーザーのプロフィールページに遷移

---

### 1.3 インクリメンタル検索（サジェスト）のテスト

#### テストケース 1.3.1: リアルタイムサジェスト
**テスト手順:**
1. 検索欄に "jo" を入力（Enterを押さない）

**期待結果:**
- 入力中に候補が表示される（デバウンス処理後）
- 最大5件の候補が表示される

#### テストケース 1.3.2: デバウンス処理
**テスト手順:**
1. 検索欄に文字を高速で連続入力

**期待結果:**
- 入力停止後300ms（設定値）で検索が実行される
- 不要な検索クエリが送信されない

---

## 2. 検索履歴機能

### 2.1 履歴保存のテスト

#### テストケース 2.1.1: 検索履歴の保存
**テスト手順:**
1. "John" で検索
2. 検索欄を再度クリック

**期待結果:**
- 「最近の検索」に "John" が表示される
- localStorage に保存される

#### テストケース 2.1.2: 履歴の上限
**前提条件:**
- 10件の検索履歴が存在

**テスト手順:**
1. 新しい検索を実行

**期待結果:**
- 最も古い履歴が削除される
- 最大10件が保持される

#### テストケース 2.1.3: 履歴の削除
**テスト手順:**
1. 検索履歴の削除ボタンをクリック

**期待結果:**
- 該当の履歴が削除される
- localStorage から削除される

---

## 3. フィルタリング機能

### 3.1 フィルターのテスト

#### テストケース 3.1.1: フレンドのみ表示
**前提条件:**
- user1 がフレンド5人、非フレンド10人を持つ

**テスト手順:**
1. "test" で検索
2. フィルターを「フレンドのみ」に設定

**期待結果:**
- フレンドのユーザーのみ表示される

#### テストケース 3.1.2: すべてのユーザー表示
**テスト手順:**
1. フィルターを「すべて」に設定

**期待結果:**
- フレンド、非フレンド両方が表示される

---

## 4. パフォーマンステスト

### 4.1 検索速度のテスト

#### テストケース 4.1.1: 大量データでの検索
**前提条件:**
- 1000人のユーザーが存在

**テスト手順:**
1. "a" で検索
2. 結果表示までの時間を測定

**期待結果:**
- 1秒以内に結果が表示される
- Firestore のインデックスを使用

#### テストケース 4.1.2: デバウンス処理の効果
**テスト手順:**
1. 検索欄に文字を連続入力（10文字）
2. 送信されたクエリ数を確認

**期待結果:**
- 1-2回のクエリのみ送信される

---

## テスト環境

### 必要な環境
- ブラウザ: Chrome, Firefox, Safari, Edge
- Firebase Emulator Suite

### テストデータ

```javascript
// テストユーザー
const testUsers = [
  { uid: "user1", handle: "johndoe", displayName: "John Doe" },
  { uid: "user2", handle: "janesmith", displayName: "Jane Smith" },
  { uid: "user3", handle: "alice", displayName: "Alice" },
  { uid: "user4", handle: "alicia", displayName: "Alicia" },
  { uid: "user5", handle: "alex", displayName: "Alex" }
];
```

---

## 自動テストの実装

### Jestテストケース例

```typescript
// lib/repos/__tests__/searchRepo.test.ts

describe('searchRepo', () => {
  describe('searchUsers', () => {
    it('should search by displayName', async () => {
      const results = await searchUsers('John');
      expect(results.some(u => u.displayName.includes('John'))).toBe(true);
    });

    it('should search by handle', async () => {
      const results = await searchUsers('johndoe');
      expect(results.some(u => u.handle === 'johndoe')).toBe(true);
    });

    it('should return empty array for no matches', async () => {
      const results = await searchUsers('zzzzz');
      expect(results).toEqual([]);
    });

    it('should limit results to 20', async () => {
      const results = await searchUsers('test');
      expect(results.length).toBeLessThanOrEqual(20);
    });
  });
});
```

---

## テスト完了チェックリスト

- [ ] ユーザー検索テストが通過
- [ ] 検索結果表示テストが通過
- [ ] サジェスト機能テストが通過
- [ ] 検索履歴テストが通過
- [ ] フィルタリングテストが通過
- [ ] パフォーマンステストが通過
- [ ] Firebase Emulator でのテスト完了
