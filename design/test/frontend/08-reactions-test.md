# リアクション機能 テスト仕様書

## テスト対象
- いいね機能
- コメント機能
- リポスト機能（将来実装）
- 絵文字リアクション（将来実装）

---

## 1. いいね機能

### 1.1 いいね追加・削除のテスト

#### テストケース 1.1.1: 画像へのいいね
**前提条件:**
- user1 でログイン
- user2 の画像が存在

**テスト手順:**
1. user2 の画像の「いいね」ボタンをクリック

**期待結果:**
- ボタンが「いいね済み」状態（ハート赤色）に変化
- いいね数が1増加
- user2 に通知が送信される
- Firestore `likes/{user1_imageId}` が作成される

#### テストケース 1.1.2: いいねの解除
**前提条件:**
- user1 が既にいいね済み

**テスト手順:**
1. 「いいね」ボタンをクリック

**期待結果:**
- ボタンが通常状態に戻る
- いいね数が1減少
- Firestore `likes/{user1_imageId}` が削除される

#### テストケース 1.1.3: 自分の画像へのいいね
**テスト手順:**
1. 自分の画像の「いいね」ボタンをクリック

**期待結果:**
- いいねできる（仕様による）
- または「自分の画像にはいいねできません」エラー

#### テストケース 1.1.4: 重複いいねの防止
**前提条件:**
- user1 が既にいいね済み

**テスト手順:**
1. Firestore に直接いいねドキュメントを追加しようと試みる

**期待結果:**
- Firestore Rules により拒否される

---

### 1.2 いいね一覧表示のテスト

#### テストケース 1.2.1: いいねしたユーザー一覧
**前提条件:**
- 画像に5人がいいね済み

**テスト手順:**
1. 画像詳細ページでいいね数をクリック

**期待結果:**
- いいねしたユーザーの一覧が表示される
- 各ユーザーのアイコン、表示名、ユーザーIDが表示される

#### テストケース 1.2.2: 自分がいいねした画像一覧
**テスト手順:**
1. プロフィールページの「いいね」タブをクリック

**期待結果:**
- 自分がいいねした画像の一覧が表示される
- 新しい順に並ぶ

---

## 2. コメント機能

### 2.1 コメント投稿のテスト

#### テストケース 2.1.1: コメントの投稿
**前提条件:**
- user1 でログイン
- user2 の画像が存在

**テスト手順:**
1. コメント入力欄に "Great photo!" を入力
2. 送信ボタンをクリック

**期待結果:**
- コメントが投稿される
- コメント一覧に即座に表示される
- user2 に通知が送信される
- Firestore `comments/{commentId}` が作成される

#### テストケース 2.1.2: 空コメントの投稿
**テスト手順:**
1. コメント入力欄を空白のまま送信

**期待結果:**
- エラー「コメントを入力してください」
- 投稿されない

#### テストケース 2.1.3: 長文コメントの制限
**テスト手順:**
1. 501文字のコメントを入力
2. 送信を試行

**期待結果:**
- エラー「500文字以内で入力してください」

#### テストケース 2.1.4: 特殊文字を含むコメント
**テスト手順:**
1. コメントに絵文字や記号を含めて投稿

**期待結果:**
- 正常に投稿される
- 絵文字や記号が正しく表示される

---

### 2.2 コメント表示のテスト

#### テストケース 2.2.1: コメント一覧の表示
**前提条件:**
- 画像に10件のコメントが存在

**テスト手順:**
1. 画像詳細ページを開く

**期待結果:**
- すべてのコメントが表示される
- 各コメントに投稿者のアイコン、表示名、内容、投稿時間が表示される
- 古い順（または新しい順）に並ぶ

#### テストケース 2.2.2: コメント数の表示
**前提条件:**
- 画像に5件のコメント

**テスト手順:**
1. タイムラインまたはアルバムページで画像を確認

**期待結果:**
- 「コメント 5件」と表示される
- クリックでコメント一覧に遷移

---

### 2.3 コメント編集・削除のテスト

#### テストケース 2.3.1: 自分のコメント編集
**前提条件:**
- user1 が投稿したコメントが存在

**テスト手順:**
1. コメントの編集ボタンをクリック
2. "Updated comment" に変更
3. 保存

**期待結果:**
- コメント内容が更新される
- 「編集済み」バッジが表示される

#### テストケース 2.3.2: 自分のコメント削除
**テスト手順:**
1. コメントの削除ボタンをクリック
2. 確認ダイアログで「削除」を選択

**期待結果:**
- コメントが削除される
- コメント数が減少
- Firestore から削除される

#### テストケース 2.3.3: 他人のコメント編集・削除試行
**前提条件:**
- user2 が投稿したコメントが存在
- user1 でログイン

**テスト手順:**
1. user2 のコメントの編集・削除ボタンを確認

**期待結果:**
- 編集・削除ボタンは表示されない
- Firestore Rules により操作が拒否される

#### テストケース 2.3.4: 画像オーナーによる他人のコメント削除
**前提条件:**
- user1（画像オーナー）の画像に user2 がコメント

**テスト手順:**
1. user1 で user2 のコメントの削除ボタンをクリック

**期待結果:**
- user1 は user2 のコメントを削除できる（仕様による）

---

## 3. リポスト機能（将来実装）

### 3.1 リポストのテスト

#### テストケース 3.1.1: 画像のリポスト
**テスト手順:**
1. 画像の「リポスト」ボタンをクリック

**期待結果:**
- リポスト成功メッセージ
- 自分のタイムラインに表示される
- 元の投稿者に通知が送信される

---

## 4. 絵文字リアクション機能（将来実装）

### 4.1 絵文字リアクションのテスト

#### テストケース 4.1.1: 絵文字リアクションの追加
**テスト手順:**
1. 画像の「リアクション」ボタンをクリック
2. 絵文字を選択

**期待結果:**
- 絵文字が画像下部に表示される
- リアクション数が増加

---

## 5. パフォーマンステスト

### 5.1 大量データ処理のテスト

#### テストケース 5.1.1: 大量コメントの表示
**前提条件:**
- 画像に500件のコメントが存在

**テスト手順:**
1. 画像詳細ページを開く
2. コメント一覧を表示

**期待結果:**
- 初回表示が2秒以内
- 仮想スクロールまたはページネーションで快適に閲覧

#### テストケース 5.1.2: いいねの高速連打防止
**テスト手順:**
1. いいねボタンを連続で10回クリック

**期待結果:**
- デバウンス処理により、1回のみ処理される
- いいね数が1のみ増加

---

## 6. セキュリティテスト

### 6.1 アクセス制御のテスト

#### テストケース 6.1.1: Firestore Rules のテスト
**テスト手順:**
1. Firebase Emulator で以下のルールをテスト:
   - 自分のいいねのみ作成・削除可能
   - 自分のコメントのみ編集・削除可能

**期待結果:**
- すべてのルールが正常に動作

#### テストケース 6.1.2: XSS対策のテスト
**テスト手順:**
1. コメントに `<script>alert('XSS')</script>` を入力
2. 投稿

**期待結果:**
- スクリプトは実行されず、テキストとして表示される

---

## テスト環境

### 必要な環境
- ブラウザ: Chrome, Firefox, Safari, Edge
- Firebase Emulator Suite

### テストデータ

```javascript
// テストいいね
{
  id: "user1_image1",
  userId: "user1",
  imageId: "image1",
  createdAt: new Date()
}

// テストコメント
{
  id: "comment1",
  imageId: "image1",
  userId: "user1",
  content: "Great photo!",
  createdAt: new Date(),
  updatedAt: new Date(),
  isEdited: false
}
```

---

## 自動テストの実装

### Jestテストケース例

```typescript
// lib/repos/__tests__/reactionRepo.test.ts

describe('reactionRepo', () => {
  describe('likeImage', () => {
    it('should like an image', async () => {
      await likeImage('user1', 'image1');
      const like = await getLike('user1', 'image1');
      expect(like).toBeDefined();
    });

    it('should prevent duplicate likes', async () => {
      await likeImage('user1', 'image1');
      await expect(
        likeImage('user1', 'image1')
      ).rejects.toThrow();
    });
  });

  describe('unlikeImage', () => {
    it('should unlike an image', async () => {
      await likeImage('user1', 'image1');
      await unlikeImage('user1', 'image1');
      const like = await getLike('user1', 'image1');
      expect(like).toBeNull();
    });
  });

  describe('addComment', () => {
    it('should add a comment', async () => {
      const commentId = await addComment('user1', 'image1', 'Nice!');
      expect(commentId).toBeDefined();
    });

    it('should validate comment length', async () => {
      await expect(
        addComment('user1', 'image1', 'a'.repeat(501))
      ).rejects.toThrow();
    });
  });

  describe('deleteComment', () => {
    it('should delete own comment', async () => {
      const commentId = await addComment('user1', 'image1', 'Test');
      await deleteComment('user1', commentId);
      const comment = await getComment(commentId);
      expect(comment).toBeNull();
    });

    it('should not delete others comment', async () => {
      const commentId = await addComment('user1', 'image1', 'Test');
      await expect(
        deleteComment('user2', commentId)
      ).rejects.toThrow();
    });
  });
});
```

---

## テスト完了チェックリスト

- [ ] いいね機能テストが通過
- [ ] コメント投稿テストが通過
- [ ] コメント編集・削除テストが通過
- [ ] いいね一覧テストが通過
- [ ] パフォーマンステストが通過
- [ ] セキュリティテストが通過
- [ ] Firebase Emulator でのテスト完了
