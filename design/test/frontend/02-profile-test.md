# プロフィール機能 テスト仕様書

## テスト対象
- プロフィール情報の表示
- プロフィール編集
- アイコン・カバー画像設定
- アカウント削除

---

## 1. プロフィール表示機能

### 1.1 基本情報表示のテスト

#### テストケース 1.1.1: 自分のプロフィール表示
**前提条件:**
- ユーザー "testuser" でログイン済み

**テスト手順:**
1. `/user/testuser` にアクセス

**期待結果:**
- 表示名、ユーザーID、自己紹介、アイコンが表示される
- 編集ボタンが表示される
- 統計情報（作成アルバム数、参加アルバム数、フレンド数、ウォッチャー数）が表示される

#### テストケース 1.1.2: 他人のプロフィール表示
**前提条件:**
- ユーザー "user1" でログイン済み
- ユーザー "user2" が存在

**テスト手順:**
1. `/user/user2` にアクセス

**期待結果:**
- 表示名、ユーザーID、自己紹介、アイコンが表示される
- 編集ボタンは非表示
- フレンド申請/ウォッチボタンが表示される
- 統計情報が表示される

#### テストケース 1.1.3: 未ログイン状態でのプロフィール表示
**テスト手順:**
1. 未ログイン状態で `/user/testuser` にアクセス

**期待結果:**
- `/login` にリダイレクト

---

### 1.2 タブ表示のテスト

#### テストケース 1.2.1: 作成アルバムタブ
**前提条件:**
- testuser が3つのアルバムを作成済み

**テスト手順:**
1. `/user/testuser` にアクセス
2. 「作成アルバム」タブをクリック

**期待結果:**
- 3つのアルバムカードが表示される
- アルバムは作成日時の降順で並ぶ

#### テストケース 1.2.2: 参加アルバムタブ
**前提条件:**
- testuser が他人のアルバムに画像を2枚追加済み

**テスト手順:**
1. `/user/testuser` にアクセス
2. 「参加アルバム」タブをクリック

**期待結果:**
- 2つのアルバムカードが表示される
- 自分が作成したアルバムは含まれない

#### テストケース 1.2.3: コメントタブ
**前提条件:**
- testuser が5つのコメントを投稿済み

**テスト手順:**
1. `/user/testuser` にアクセス
2. 「コメント」タブをクリック

**期待結果:**
- 最大50件のコメントが表示される
- 各コメントには対象アルバムへのリンクが含まれる

#### テストケース 1.2.4: 画像タブ
**前提条件:**
- testuser が10枚の画像をアップロード済み

**テスト手順:**
1. `/user/testuser` にアクセス
2. 「画像」タブをクリック

**期待結果:**
- 画像グリッドが表示される
- クリックで拡大表示

---

## 2. プロフィール編集機能

### 2.1 基本情報編集のテスト

#### テストケース 2.1.1: 表示名の編集
**テスト手順:**
1. 自分のプロフィールページで編集ボタンをクリック
2. 表示名を "New Name" に変更
3. 保存ボタンをクリック

**期待結果:**
- 成功メッセージ「プロフィールを更新しました」
- 画面に新しい表示名が反映される
- ページリロード後も変更が保持される

#### テストケース 2.1.2: 表示名のバリデーション
**テスト手順:**
1. 編集モードで表示名を空白にする
2. 保存を試行
3. 41文字の表示名を入力
4. 保存を試行

**期待結果:**
- 手順2: エラー「表示名を入力してください」
- 手順4: エラー「40文字以内で入力してください」

#### テストケース 2.1.3: ユーザーIDの編集
**前提条件:**
- "newhandle" というハンドルが未使用

**テスト手順:**
1. 編集モードでユーザーIDを "newhandle" に変更
2. 保存ボタンをクリック
3. `/user/newhandle` にアクセス

**期待結果:**
- 手順2: 成功メッセージ
- 手順3: 自分のプロフィールが表示される
- 旧URL `/user/oldhandle` は404

#### テストケース 2.1.4: ユーザーID重複チェック
**前提条件:**
- "existinguser" というハンドルが既に存在

**テスト手順:**
1. 編集モードでユーザーIDを "existinguser" に変更
2. 保存を試行

**期待結果:**
- エラー「このユーザーIDは既に使用されています」
- 保存されない

#### テストケース 2.1.5: 自己紹介の編集
**テスト手順:**
1. 編集モードで自己紹介に200文字のテキストを入力
2. 保存
3. 201文字のテキストを入力
4. 保存を試行

**期待結果:**
- 手順2: 保存成功
- 手順4: エラー「200文字以内で入力してください」

---

### 2.2 URL情報編集のテスト

#### テストケース 2.2.1: VRChat URLの設定
**テスト手順:**
1. 編集モードでVRChat URL欄に "https://vrchat.com/home/user/usr_xxx" を入力
2. 保存

**期待結果:**
- 保存成功
- プロフィールにVRChatアイコン付きリンクが表示される

#### テストケース 2.2.2: その他URLの設定（最大3つ）
**テスト手順:**
1. 編集モードでURL1に "https://twitter.com/user" を入力
2. URL2に "https://github.com/user" を入力
3. URL3に "https://example.com" を入力
4. 保存

**期待結果:**
- 3つのリンクがすべて表示される
- 各リンクをクリックすると正しいURLに遷移

#### テストケース 2.2.3: 無効なURL形式
**テスト手順:**
1. VRChat URL欄に "not a url" を入力
2. 保存を試行

**期待結果:**
- エラー「有効なURLを入力してください」

---

### 2.3 その他情報編集のテスト

#### テストケース 2.3.1: 言語・性別・年齢の設定
**テスト手順:**
1. 編集モードで言語を "日本語" に設定
2. 性別を "その他" に設定
3. 年齢を "25" に設定
4. 保存

**期待結果:**
- すべての情報が保存される
- プロフィールに表示される

#### テストケース 2.3.2: 住所・生年月日の設定
**テスト手順:**
1. 住所を "東京都" に設定
2. 生年月日を "1998-01-01" に設定
3. 保存

**期待結果:**
- 保存成功
- プロフィールに表示される（生年月日から年齢が自動計算される場合は年齢も更新）

---

## 3. アイコン・画像設定機能

### 3.1 プロフィールアイコン設定のテスト

#### テストケース 3.1.1: アイコンのアップロード
**テスト手順:**
1. アイコンをクリックして編集モーダルを開く
2. 画像ファイル（500x500px, 200KB）を選択
3. トリミング領域を調整
4. 「保存」をクリック

**期待結果:**
- トリミングUIが表示される
- 保存後、新しいアイコンが即座に反映される
- Firebase Storage に画像が保存される

#### テストケース 3.1.2: アイコンのトリミング
**テスト手順:**
1. 横長の画像（1200x600px）を選択
2. 正方形のトリミング領域を中央に配置
3. ズームスライダーで拡大
4. 保存

**期待結果:**
- トリミング領域が正方形に制限される
- ズーム機能が正常に動作
- 保存後、トリミングされた画像が512x512pxで保存される

#### テストケース 3.1.3: アイコンのファイルサイズ制限
**テスト手順:**
1. 6MBの画像を選択

**期待結果:**
- エラー「5MB以下の画像を選択してください」
- アップロードされない

#### テストケース 3.1.4: アイコンのファイル形式制限
**テスト手順:**
1. PDFファイルを選択
2. テキストファイルを選択

**期待結果:**
- エラー「画像ファイルを選択してください」
- アップロードされない

---

### 3.2 カバー画像・バナー画像のテスト

#### テストケース 3.2.1: カバー画像のアップロード
**テスト手順:**
1. カバー画像エリアをクリック
2. 横長の画像（1600x400px）を選択
3. 保存

**期待結果:**
- 画像がプロフィール上部に表示される
- 適切なアスペクト比で表示される

#### テストケース 3.2.2: バナー画像のアップロード
**テスト手順:**
1. バナー画像エリアをクリック
2. 画像を選択
3. 保存

**期待結果:**
- 画像が保存される
- プロフィールに表示される

#### テストケース 3.2.3: 画像の削除
**テスト手順:**
1. 設定済みのカバー画像の削除ボタンをクリック
2. 確認ダイアログで「削除」を選択

**期待結果:**
- カバー画像が削除される
- デフォルト画像またはプレースホルダーが表示される
- Firebase Storage から画像が削除される

---

## 4. アカウント削除機能

### 4.1 アカウント削除のテスト

#### テストケース 4.1.1: アカウント削除フロー
**テスト手順:**
1. プロフィール設定から「アカウントを削除」をクリック
2. 確認ダイアログで理由を選択（任意）
3. 「理解しました」チェックボックスをチェック
4. パスワードを入力
5. 「削除する」ボタンをクリック

**期待結果:**
- 手順2: 警告メッセージが表示される
- 手順5: 削除処理が実行される
- ログアウトされ、トップページにリダイレクト
- 該当ユーザーでログイン試行すると失敗

#### テストケース 4.1.2: 削除時のデータクリーンアップ
**前提条件:**
- testuser がアルバム3つ、コメント5つ、画像10枚を持つ

**テスト手順:**
1. アカウント削除を実行
2. Firestore で users/{uid} を確認
3. 該当ユーザーの albums, comments, albumImages を確認
4. 該当ユーザーの friends, watches, likes を確認

**期待結果:**
- 手順2: ユーザードキュメントが削除されている
- 手順3: すべてのアルバム、コメント、画像が削除されている
- 手順4: すべてのフレンド関係、ウォッチ、いいねが削除されている

#### テストケース 4.1.3: 削除のキャンセル
**テスト手順:**
1. 「アカウントを削除」をクリック
2. 確認ダイアログで「キャンセル」をクリック

**期待結果:**
- ダイアログが閉じる
- アカウントは削除されない

#### テストケース 4.1.4: 誤ったパスワードでの削除試行
**テスト手順:**
1. アカウント削除ダイアログで誤ったパスワードを入力
2. 「削除する」をクリック

**期待結果:**
- エラー「パスワードが正しくありません」
- アカウントは削除されない

---

## 5. 統計情報のテスト

### 5.1 統計表示のテスト

#### テストケース 5.1.1: 作成アルバム数のカウント
**前提条件:**
- testuser が5つのアルバムを作成

**テスト手順:**
1. `/user/testuser` にアクセス

**期待結果:**
- 「作成アルバム: 5」と表示される

#### テストケース 5.1.2: 参加アルバム数のカウント
**前提条件:**
- testuser が3つの他人のアルバムに画像を追加

**テスト手順:**
1. `/user/testuser` にアクセス

**期待結果:**
- 「参加アルバム: 3」と表示される
- 自分のアルバムは含まれない

#### テストケース 5.1.3: フレンド数のカウント
**前提条件:**
- testuser が4人とフレンド関係（accepted）

**テスト手順:**
1. `/user/testuser` にアクセス

**期待結果:**
- 「フレンド: 4」と表示される
- pending 状態のものは含まれない

#### テストケース 5.1.4: ウォッチャー数のカウント
**前提条件:**
- 7人が testuser をウォッチ中

**テスト手順:**
1. `/user/testuser` にアクセス

**期待結果:**
- 「ウォッチャー: 7」と表示される

#### テストケース 5.1.5: 統計のリアルタイム更新
**テスト手順:**
1. `/user/testuser` を開いた状態で別ウィンドウで新しいアルバムを作成
2. プロフィールページを確認

**期待結果:**
- 手動リロードすると作成アルバム数が増加（リアルタイム更新は今後実装予定）

---

## 6. レスポンシブデザインのテスト

### 6.1 モバイル表示のテスト

#### テストケース 6.1.1: スマートフォンでのプロフィール表示
**テスト手順:**
1. スマートフォン（375px幅）でプロフィールページを表示

**期待結果:**
- すべての要素が画面幅に収まる
- タブが縦並びまたはスクロール可能
- アイコンとカバー画像が適切なサイズで表示

#### テストケース 6.1.2: タブレットでのプロフィール表示
**テスト手順:**
1. タブレット（768px幅）でプロフィールページを表示

**期待結果:**
- レイアウトが適切に調整される
- 編集ボタンが押しやすいサイズ

---

## 7. パフォーマンステスト

### 7.1 読み込み速度のテスト

#### テストケース 7.1.1: 大量データ表示
**前提条件:**
- testuser が100個のアルバムを作成

**テスト手順:**
1. `/user/testuser` にアクセス
2. 作成アルバムタブを開く

**期待結果:**
- 初期表示は最大50件
- スクロールで追加読み込み（無限スクロール）
- 初期表示は3秒以内

#### テストケース 7.1.2: 画像読み込みの最適化
**テスト手順:**
1. 画像タブを開く
2. スクロールして下部の画像を確認

**期待結果:**
- 画面外の画像は遅延読み込み
- サムネイル画像が使用される（512px版ではなく128px版）

---

## テスト環境

### 必要な環境
- ブラウザ: Chrome, Firefox, Safari, Edge
- デバイス: デスクトップ（1920x1080）、タブレット（768x1024）、スマートフォン（375x667）
- Firebase Emulator Suite

### テストデータ

```javascript
// テストユーザー1
{
  uid: "test-uid-1",
  handle: "testuser",
  displayName: "Test User",
  bio: "これはテストユーザーです",
  iconURL: "https://example.com/icon.jpg",
  coverURL: "https://example.com/cover.jpg",
  bannerURL: null,
  vrchatURL: "https://vrchat.com/home/user/usr_xxx",
  otherURLs: ["https://twitter.com/test", "https://github.com/test"],
  language: "日本語",
  gender: "その他",
  age: 25,
  location: "東京都",
  birthDate: "1998-01-01"
}

// テストアルバムデータ（5件）
[
  { id: "album1", ownerId: "test-uid-1", title: "Album 1", createdAt: new Date() },
  // ...
]
```

---

## 自動テストの実装

### Jestテストケース例

```typescript
// lib/repos/__tests__/userRepo.test.ts

describe('userRepo - profile operations', () => {
  describe('updateUser', () => {
    it('should update displayName', async () => {
      await updateUser('test-uid', { displayName: 'New Name' });
      const user = await getUser('test-uid');
      expect(user.displayName).toBe('New Name');
    });

    it('should validate displayName length', async () => {
      await expect(
        updateUser('test-uid', { displayName: 'a'.repeat(41) })
      ).rejects.toThrow();
    });

    it('should prevent duplicate handle', async () => {
      await createUser('uid1', { handle: 'existing' });
      await expect(
        updateUser('uid2', { handle: 'existing' })
      ).rejects.toThrow();
    });
  });

  describe('deleteUser', () => {
    it('should delete user and related data', async () => {
      await deleteUserAccount('test-uid');
      const user = await getUser('test-uid');
      expect(user).toBeNull();
    });
  });
});
```

---

## テスト完了チェックリスト

- [ ] プロフィール表示テストが通過
- [ ] プロフィール編集テストが通過
- [ ] アイコン設定テストが通過
- [ ] カバー・バナー画像テストが通過
- [ ] アカウント削除テストが通過
- [ ] 統計情報テストが通過
- [ ] レスポンシブテストが通過
- [ ] パフォーマンステストが通過
- [ ] 異なるブラウザでの動作確認
- [ ] Firebase Emulator でのテスト完了
