# 通知機能 テスト仕様書

## テスト対象
- 通知の受信・表示
- 通知タイプ（フレンド申請、いいね、コメント等）
- 既読・未読管理
- リアルタイム更新

---

## 1. 通知受信機能

### 1.1 フレンド関連通知のテスト

#### テストケース 1.1.1: フレンド申請通知
**前提条件:**
- user2 から user1 へフレンド申請

**テスト手順:**
1. user1 でログイン
2. 通知アイコンを確認

**期待結果:**
- 通知バッジに "1" が表示される
- 通知一覧に「user2 からフレンド申請がありました」
- 通知をクリックで user2 のプロフィールに遷移

#### テストケース 1.1.2: フレンド申請承認通知
**前提条件:**
- user1 から user2 へ申請し、user2 が承認

**テスト手順:**
1. user1 で通知を確認

**期待結果:**
- 「user2 があなたのフレンド申請を承認しました」という通知

---

### 1.2 アルバム関連通知のテスト

#### テストケース 1.2.1: 自分のアルバムへの画像追加通知
**前提条件:**
- user2 が user1 のアルバムに画像を追加

**テスト手順:**
1. user1 で通知を確認

**期待結果:**
- 「user2 があなたのアルバムに画像を追加しました」という通知
- 通知をクリックでそのアルバムに遷移

---

### 1.3 いいね・コメント通知のテスト

#### テストケース 1.3.1: 画像へのいいね通知
**前提条件:**
- user2 が user1 の画像にいいね

**テスト手順:**
1. user1 で通知を確認

**期待結果:**
- 「user2 があなたの画像にいいねしました」という通知
- 通知をクリックで該当画像に遷移

#### テストケース 1.3.2: コメント通知
**前提条件:**
- user2 が user1 の画像にコメント

**テスト手順:**
1. user1 で通知を確認

**期待結果:**
- 「user2 があなたの画像にコメントしました: "Nice!"」
- コメント内容のプレビューが表示される

---

### 1.4 ウォッチ通知のテスト（オプション）

#### テストケース 1.4.1: 新しいウォッチャー通知
**前提条件:**
- user2 が user1 をウォッチ開始

**テスト手順:**
1. user1 で通知を確認

**期待結果:**
- 「user2 があなたをウォッチしました」という通知（仕様による）

---

## 2. 通知一覧表示機能

### 2.1 一覧表示のテスト

#### テストケース 2.1.1: 通知一覧の表示
**前提条件:**
- user1 に10件の通知が存在

**テスト手順:**
1. 通知アイコンをクリック

**期待結果:**
- 最新10件の通知が表示される
- 各通知に送信者のアイコン、内容、時間が表示される
- 未読通知は背景色が異なる

#### テストケース 2.1.2: 通知が0件の場合
**テスト手順:**
1. 通知が0件の状態で通知アイコンをクリック

**期待結果:**
- 「通知はありません」というメッセージ

#### テストケース 2.1.3: 古い通知の読み込み
**前提条件:**
- user1 に50件の通知が存在

**テスト手順:**
1. 通知一覧を開く
2. 下部までスクロール

**期待結果:**
- 追加の通知が読み込まれる
- 無限スクロールまたはページネーション

---

## 3. 既読・未読管理機能

### 3.1 既読処理のテスト

#### テストケース 3.1.1: 通知を開いたときの既読処理
**前提条件:**
- 未読通知が3件存在

**テスト手順:**
1. 通知一覧を開く

**期待結果:**
- 通知バッジが消える（または0になる）
- 表示された通知が既読状態になる

#### テストケース 3.1.2: 個別通知の既読処理
**テスト手順:**
1. 特定の通知をクリック

**期待結果:**
- その通知が既読になる
- 背景色が変化

#### テストケース 3.1.3: すべて既読にする機能
**テスト手順:**
1. 通知一覧で「すべて既読にする」ボタンをクリック

**期待結果:**
- すべての通知が既読状態になる
- 通知バッジが0になる

---

## 4. リアルタイム更新機能

### 4.1 新規通知のリアルタイム表示テスト

#### テストケース 4.1.1: 新しい通知の即座表示
**前提条件:**
- user1 でログイン中
- user2 が user1 にフレンド申請を送信

**テスト手順:**
1. user1 の画面を監視

**期待結果:**
- 手動リロードなしで通知バッジが増加
- 通知一覧を開くと新しい通知が表示される

#### テストケース 4.1.2: 複数の新規通知
**テスト手順:**
1. 短時間に3つの通知を受信

**期待結果:**
- 通知バッジが "3" と表示される
- すべての通知が一覧に表示される

---

## 5. 通知削除機能

### 5.1 削除のテスト

#### テストケース 5.1.1: 個別通知の削除
**テスト手順:**
1. 通知一覧で特定の通知の削除ボタンをクリック

**期待結果:**
- その通知が一覧から消える
- Firestore から削除される

#### テストケース 5.1.2: すべての通知削除
**テスト手順:**
1. 「すべて削除」ボタンをクリック
2. 確認ダイアログで「削除」を選択

**期待結果:**
- すべての通知が削除される
- 通知バッジが0になる

---

## 6. 通知設定機能（オプション）

### 6.1 通知ON/OFF設定のテスト

#### テストケース 6.1.1: 特定タイプの通知を無効化
**テスト手順:**
1. 設定で「いいね通知」をオフにする
2. 誰かが自分の画像にいいね

**期待結果:**
- いいね通知は届かない
- 他の通知は正常に届く

---

## パフォーマンステスト

### テストケース P.1: 大量通知の処理
**前提条件:**
- user1 に1000件の通知が存在

**テスト手順:**
1. 通知一覧を開く

**期待結果:**
- 初回表示が2秒以内
- 仮想スクロールまたはページネーションで快適に閲覧可能

---

## テスト環境

### 必要な環境
- ブラウザ: Chrome, Firefox, Safari, Edge
- Firebase Emulator Suite

### テストデータ

```javascript
// テスト通知
{
  id: "notif1",
  recipientId: "user1",
  senderId: "user2",
  type: "friend_request",
  content: "user2 からフレンド申請がありました",
  isRead: false,
  createdAt: new Date()
}
```

---

## 自動テストの実装

### Jestテストケース例

```typescript
// lib/repos/__tests__/notificationRepo.test.ts

describe('notificationRepo', () => {
  describe('createNotification', () => {
    it('should create notification', async () => {
      const notifId = await createNotification({
        recipientId: 'user1',
        senderId: 'user2',
        type: 'friend_request'
      });
      expect(notifId).toBeDefined();
    });
  });

  describe('markAsRead', () => {
    it('should mark notification as read', async () => {
      await markAsRead('user1', 'notif1');
      const notif = await getNotification('notif1');
      expect(notif.isRead).toBe(true);
    });
  });

  describe('deleteNotification', () => {
    it('should delete notification', async () => {
      await deleteNotification('user1', 'notif1');
      const notif = await getNotification('notif1');
      expect(notif).toBeNull();
    });
  });
});
```

---

## テスト完了チェックリスト

- [ ] 通知受信テストが通過
- [ ] 通知一覧表示テストが通過
- [ ] 既読・未読管理テストが通過
- [ ] リアルタイム更新テストが通過
- [ ] 通知削除テストが通過
- [ ] パフォーマンステストが通過
- [ ] Firebase Emulator でのテスト完了
