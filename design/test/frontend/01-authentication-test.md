# 認証機能 テスト仕様書

## テスト対象
- 新規登録
- ログイン
- パスワードリセット
- ユーザー名・ユーザーID設定

---

## 1. 新規登録機能

### 1.1 パスワード要件のテスト

#### テストケース 1.1.1: パスワード入力の2回一致判定
**前提条件:**
- 新規登録ページにアクセス済み

**テスト手順:**
1. パスワード1に "Test1234" を入力
2. パスワード2に "Test1234" を入力
3. パスワード2に "Test5678" を入力

**期待結果:**
- 手順2: 一致メッセージが表示される、エラーなし
- 手順3: 不一致エラーメッセージが表示される、送信ボタンが無効化

#### テストケース 1.1.2: パスワード強度メーター
**テスト手順:**
1. "test" を入力
2. "test1234" を入力
3. "Test1234" を入力
4. "Test1234!" を入力

**期待結果:**
- 手順1: 弱い（赤）
- 手順2: 普通（黄）
- 手順3: 良い（緑）
- 手順4: 強い（濃い緑）

#### テストケース 1.1.3: パスワード表示/非表示トグル
**テスト手順:**
1. パスワードフィールドに "Test1234" を入力
2. 「表示」ボタンをクリック
3. 「非表示」ボタンをクリック

**期待結果:**
- 手順1: パスワードは `****` で表示
- 手順2: "Test1234" がプレーンテキストで表示
- 手順3: 再び `****` で表示

#### テストケース 1.1.4: Firebase パスワード要件
**テスト手順:**
1. "password" を入力して登録
2. "PASSWORD" を入力して登録
3. "12345678" を入力して登録
4. "Pass1234" を入力して登録

**期待結果:**
- 手順1: エラー「小文字と数字を含める必要があります」
- 手順2: エラー「小文字と数字を含める必要があります」
- 手順3: エラー「小文字と数字を含める必要があります」
- 手順4: 登録成功

---

### 1.2 ユーザー名・ユーザーID設定のテスト

#### テストケース 1.2.1: 表示名（displayName）のバリデーション
**テスト手順:**
1. 空白を入力
2. 41文字の文字列を入力
3. 40文字の文字列を入力
4. 同じ表示名を持つユーザーが既に存在する名前を入力

**期待結果:**
- 手順1: エラー「表示名を入力してください」
- 手順2: エラー「40文字以内で入力してください」
- 手順3: 登録可能
- 手順4: 登録可能（重複許容）

#### テストケース 1.2.2: ユーザーID（handle）のバリデーション
**テスト手順:**
1. "ab" を入力（2文字）
2. "abc" を入力（3文字）
3. "a".repeat(21) を入力（21文字）
4. "test-user" を入力（ハイフン含む）
5. "test_user" を入力（アンダースコア含む）
6. "TestUser" を入力（大文字含む）

**期待結果:**
- 手順1: エラー「3文字以上必要です」
- 手順2: バリデーション通過
- 手順3: エラー「20文字以内で入力してください」
- 手順4: エラー「英数字とアンダースコアのみ使用可能です」
- 手順5: バリデーション通過
- 手順6: 自動的に "testuser" に変換される

#### テストケース 1.2.3: ユーザーID重複チェック
**前提条件:**
- "testuser" というハンドルが既に登録済み

**テスト手順:**
1. "testuser" を入力
2. 450ms 待機
3. "newuser" を入力
4. 450ms 待機

**期待結果:**
- 手順2: エラー「このユーザーIDは既に使用されています」
- 手順4: 成功「このユーザーIDは利用可能です」

#### テストケース 1.2.4: 予約語のチェック
**テスト手順:**
1. "admin" を入力
2. "support" を入力
3. "system" を入力
4. "admins" を入力

**期待結果:**
- 手順1-3: エラー「この名前は予約されています」
- 手順4: バリデーション通過

---

### 1.3 登録フローのテスト

#### テストケース 1.3.1: 未登録状態のアクセス制限
**テスト手順:**
1. 未ログイン状態で `/timeline` にアクセス
2. 未ログイン状態で `/user/testuser` にアクセス
3. 未ログイン状態で `/` にアクセス
4. 未ログイン状態で `/login` にアクセス

**期待結果:**
- 手順1-2: `/` または `/login` にリダイレクト
- 手順3-4: ページが正常に表示

#### テストケース 1.3.2: 仮登録状態
**テスト手順:**
1. メールアドレス "test@example.com" とパスワードで登録
2. メール検証前に `/timeline` にアクセス
3. メールの検証リンクをクリック

**期待結果:**
- 手順1: 「確認メールを送信しました」メッセージ表示
- 手順2: `/login` にリダイレクト
- 手順3: 次ステップページ（ユーザー名・ID設定）にリダイレクト

#### テストケース 1.3.3: 本登録完了
**テスト手順:**
1. メール検証済みの状態で次ステップページにアクセス
2. 表示名 "Test User"、ユーザーID "testuser" を入力
3. 送信

**期待結果:**
- 手順3: `/user/testuser` にリダイレクト、全機能にアクセス可能

---

## 2. ログイン機能

### 2.1 ログインのテスト

#### テストケース 2.1.1: 正常なログイン
**前提条件:**
- "test@example.com" / "Test1234" で登録済み

**テスト手順:**
1. メールアドレス "test@example.com" を入力
2. パスワード "Test1234" を入力
3. ログインボタンをクリック

**期待結果:**
- `/timeline` にリダイレクト
- ヘッダーにユーザー情報が表示

#### テストケース 2.1.2: 誤ったパスワード
**テスト手順:**
1. メールアドレス "test@example.com" を入力
2. パスワード "WrongPass" を入力
3. ログインボタンをクリック

**期待結果:**
- エラーメッセージ「メールアドレスまたはパスワードが正しくありません」
- ログインページに留まる

#### テストケース 2.1.3: 存在しないメールアドレス
**テスト手順:**
1. メールアドレス "nonexistent@example.com" を入力
2. パスワード "Test1234" を入力
3. ログインボタンをクリック

**期待結果:**
- エラーメッセージ「メールアドレスまたはパスワードが正しくありません」
- ログインページに留まる

#### テストケース 2.1.4: 空フィールド
**テスト手順:**
1. メールアドレスとパスワードを空白のままログインボタンをクリック
2. メールアドレスのみ入力してログインボタンをクリック
3. パスワードのみ入力してログインボタンをクリック

**期待結果:**
- すべて: バリデーションエラー、送信されない

---

## 3. パスワードリセット機能

### 3.1 パスワードリセット申請のテスト

#### テストケース 3.1.1: 登録済みメールアドレス
**テスト手順:**
1. `/forgot-password` にアクセス
2. 登録済みのメールアドレス "test@example.com" を入力
3. 送信ボタンをクリック

**期待結果:**
- 中立メッセージ「入力されたメールアドレスに一致するアカウントがあれば、パスワード再設定の案内を送信しました」
- メール受信（実際にメールが送信される）

#### テストケース 3.1.2: 未登録メールアドレス
**テスト手順:**
1. `/forgot-password` にアクセス
2. 未登録のメールアドレス "unknown@example.com" を入力
3. 送信ボタンをクリック

**期待結果:**
- 同じ中立メッセージ（列挙攻撃防止）
- メールは送信されない（ユーザーは判別できない）

#### テストケース 3.1.3: 無効なメールアドレス形式
**テスト手順:**
1. "notanemail" を入力
2. 送信ボタンをクリック

**期待結果:**
- バリデーションエラー「有効なメールアドレスを入力してください」

### 3.2 パスワードリセット実行のテスト

#### テストケース 3.2.1: 正常なパスワードリセット
**前提条件:**
- パスワードリセットメールを受信済み

**テスト手順:**
1. メール内のリンクをクリック
2. `/reset-password?oobCode=xxx` に遷移
3. 新しいパスワード "NewPass1234" を入力
4. 確認パスワード "NewPass1234" を入力
5. 送信ボタンをクリック
6. 新しいパスワードでログインを試行

**期待結果:**
- 手順5: 成功メッセージ「パスワードが変更されました」
- 手順6: ログイン成功

#### テストケース 3.2.2: 期限切れトークン
**テスト手順:**
1. 期限切れのリセットリンクをクリック
2. 新しいパスワードを入力して送信

**期待結果:**
- エラーメッセージ「このリンクは期限切れです。再度リセットを申請してください」

#### テストケース 3.2.3: 使用済みトークン
**テスト手順:**
1. 一度使用したリセットリンクを再度クリック
2. パスワードを入力して送信

**期待結果:**
- エラーメッセージ「このリンクは既に使用されています」

---

## 4. プロフィールURL機能

### 4.1 プロフィールURLのテスト

#### テストケース 4.1.1: 正常なハンドルアクセス
**前提条件:**
- "testuser" というハンドルのユーザーが存在

**テスト手順:**
1. `/user/testuser` にアクセス

**期待結果:**
- testuser のプロフィールページが表示される

#### テストケース 4.1.2: 存在しないハンドル
**テスト手順:**
1. `/user/nonexistentuser` にアクセス

**期待結果:**
- 404 ページまたは「ユーザーが見つかりません」メッセージ

#### テストケース 4.1.3: 予約語のハンドル
**テスト手順:**
1. `/user/admin` にアクセス
2. `/user/support` にアクセス

**期待結果:**
- 404 ページ（予約語は登録不可のため存在しない）

---

## 5. エッジケース・セキュリティテスト

### 5.1 セキュリティテスト

#### テストケース 5.1.1: SQLインジェクション対策
**テスト手順:**
1. ユーザーID入力欄に `admin'; DROP TABLE users; --` を入力
2. パスワード入力欄に `' OR '1'='1` を入力

**期待結果:**
- バリデーションエラーまたは安全に処理される
- データベースに影響なし

#### テストケース 5.1.2: XSS対策
**テスト手順:**
1. 表示名に `<script>alert('XSS')</script>` を入力
2. 登録して自分のプロフィールを表示

**期待結果:**
- スクリプトは実行されず、テキストとして表示される

#### テストケース 5.1.3: CSRF対策
**テスト手順:**
1. 外部サイトから登録リクエストを送信

**期待結果:**
- リクエストが拒否される（CSRFトークンチェック）

### 5.2 パフォーマンステスト

#### テストケース 5.2.1: 重複チェックのデバウンス
**テスト手順:**
1. ユーザーID入力欄に素早く "testuser" と入力
2. 入力完了から450ms以内に確認
3. 450ms経過後に確認

**期待結果:**
- 手順2: 重複チェック未実施
- 手順3: 重複チェック実施、結果表示

#### テストケース 5.2.2: 連続ログイン試行の制限
**テスト手順:**
1. 誤ったパスワードで5回連続ログイン試行

**期待結果:**
- 5回目以降: 「試行回数が多すぎます。しばらくしてから再度お試しください」（今後実装予定）

---

## テスト環境

### 必要な環境
- ブラウザ: Chrome, Firefox, Safari (最新版)
- デバイス: デスクトップ、タブレット、モバイル
- Firebase Emulator Suite (ローカルテスト用)

### テストデータ
```javascript
// 有効なテストユーザー
{
  email: "test@example.com",
  password: "Test1234",
  displayName: "Test User",
  handle: "testuser"
}

// 予約語リスト
["admin", "support", "system", "login", "register", "timeline", "user", "album", "search", "notification"]
```

---

## 自動テストの実装

### Jestテストケース例

```typescript
// lib/repos/__tests__/userRepo.test.ts

describe('userRepo', () => {
  describe('handle validation', () => {
    it('should reject handles shorter than 3 characters', () => {
      expect(validateHandle('ab')).toHaveProperty('error');
    });

    it('should reject handles longer than 20 characters', () => {
      expect(validateHandle('a'.repeat(21))).toHaveProperty('error');
    });

    it('should reject handles with special characters', () => {
      expect(validateHandle('test-user')).toHaveProperty('error');
    });

    it('should accept valid handles', () => {
      expect(validateHandle('test_user')).toHaveProperty('valid', true);
    });

    it('should convert uppercase to lowercase', () => {
      const result = validateHandle('TestUser');
      expect(result.normalized).toBe('testuser');
    });
  });

  describe('handle duplicate check', () => {
    it('should return true when handle is available', async () => {
      const available = await checkHandleAvailable('newuser');
      expect(available).toBe(true);
    });

    it('should return false when handle is taken', async () => {
      const available = await checkHandleAvailable('testuser');
      expect(available).toBe(false);
    });
  });
});
```

---

## テスト完了チェックリスト

- [ ] すべての新規登録テストケースが通過
- [ ] すべてのログインテストケースが通過
- [ ] すべてのパスワードリセットテストケースが通過
- [ ] プロフィールURLテストが通過
- [ ] セキュリティテストが通過
- [ ] パフォーマンステストが通過
- [ ] モバイル/タブレットで動作確認
- [ ] 異なるブラウザで動作確認
- [ ] Firebase Emulator でのテスト完了
- [ ] 本番環境での動作確認
