# タイムライン機能 テスト仕様書

## テスト対象
- タイムライン表示（フレンド・ウォッチ中のユーザーの投稿）
- 無限スクロール機能
- リアルタイム更新
- フィルタリング・ソート機能

---

## 1. タイムライン表示機能

### 1.1 基本表示のテスト

#### テストケース 1.1.1: タイムラインの初期表示
**前提条件:**
- user1 でログイン
- user1 が5人のフレンドを持つ
- フレンドが合計30件の画像を投稿済み

**テスト手順:**
1. `/timeline` にアクセス

**期待結果:**
- 最新20件の投稿が表示される
- 各投稿には以下の情報が含まれる:
  - 投稿者のアイコン、表示名、ユーザーID
  - 投稿画像
  - アルバムタイトル
  - 投稿日時
  - いいね数、コメント数
- 投稿は新しい順に並ぶ

#### テストケース 1.1.2: フレンドがいない場合のタイムライン
**前提条件:**
- user1 でログイン
- user1 にフレンド・ウォッチがいない

**テスト手順:**
1. `/timeline` にアクセス

**期待結果:**
- 「フレンドやウォッチしているユーザーがいません」というメッセージが表示される
- フレンド検索やユーザー検索へのリンクが表示される

#### テストケース 1.1.3: 未ログイン状態でのアクセス
**テスト手順:**
1. ログアウト
2. `/timeline` にアクセス

**期待結果:**
- `/login` にリダイレクト

---

### 1.2 投稿内容の表示テスト

#### テストケース 1.2.1: 画像投稿の表示
**前提条件:**
- user2（フレンド）がアルバムに画像を追加

**テスト手順:**
1. user1 でタイムラインを表示

**期待結果:**
- user2 の投稿が表示される
- 画像をクリックすると拡大表示される
- アルバムタイトルをクリックするとアルバム詳細ページに遷移

#### テストケース 1.2.2: アルバム作成投稿の表示
**前提条件:**
- user3（ウォッチ中）が新しいアルバムを作成

**テスト手順:**
1. user1 でタイムラインを表示

**期待結果:**
- 「user3 が新しいアルバムを作成しました」という投稿が表示される
- アルバムのカバー画像（またはプレースホルダー）が表示される

#### テストケース 1.2.3: 複数画像投稿の表示
**前提条件:**
- user2 が同じアルバムに3枚の画像を連続で追加

**テスト手順:**
1. user1 でタイムラインを表示

**期待結果:**
- 3つの投稿が個別に表示される（またはグループ化表示、仕様による）
- 各画像が正しく表示される

---

## 2. 無限スクロール機能

### 2.1 スクロール読み込みのテスト

#### テストケース 2.1.1: 追加読み込み（基本動作）
**前提条件:**
- タイムラインに100件の投稿が存在
- 初回表示は20件

**テスト手順:**
1. タイムラインを表示
2. ページ下部までスクロール

**期待結果:**
- 下部に到達すると次の20件が自動的に読み込まれる
- ローディングインジケーターが表示される
- スクロール位置が維持される

#### テストケース 2.1.2: すべての投稿を読み込んだ場合
**前提条件:**
- タイムラインに25件の投稿が存在
- 初回表示20件

**テスト手順:**
1. タイムラインを表示
2. 下部までスクロール

**期待結果:**
- 残り5件が読み込まれる
- 「すべての投稿を表示しました」というメッセージが表示される
- それ以上の読み込みは発生しない

#### テストケース 2.1.3: 高速スクロールでの多重読み込み防止
**テスト手順:**
1. タイムラインを高速スクロール

**期待結果:**
- 読み込み中は次の読み込みが開始されない
- 1度に1ページ分のみ読み込まれる

---

## 3. リアルタイム更新機能

### 3.1 新規投稿の反映テスト

#### テストケース 3.1.1: 新しい投稿の自動表示
**前提条件:**
- user1 でタイムラインを表示中
- user2（フレンド）が新しい画像を投稿

**テスト手順:**
1. タイムライン表示中に user2 が画像を投稿
2. タイムラインを確認

**期待結果:**
- 手動リロードなしで新しい投稿が表示される（リアルタイムリスナー使用）
- 「新しい投稿があります」バッジが表示される
- クリックでトップにスクロール

#### テストケース 3.1.2: リアルタイム更新の通知
**テスト手順:**
1. タイムライン表示中にスクロールして途中まで見る
2. 新しい投稿が追加される

**期待結果:**
- 画面上部に「新しい投稿が3件あります」というバッジが表示される
- バッジをクリックするとトップに戻り、新しい投稿が表示される

---

## 4. フィルタリング機能

### 4.1 投稿タイプフィルターのテスト

#### テストケース 4.1.1: すべての投稿表示
**テスト手順:**
1. フィルターを「すべて」に設定

**期待結果:**
- 画像投稿、アルバム作成、すべての種類の投稿が表示される

#### テストケース 4.1.2: 画像投稿のみ表示
**テスト手順:**
1. フィルターを「画像」に設定

**期待結果:**
- 画像投稿のみ表示される
- アルバム作成などの投稿は非表示

#### テストケース 4.1.3: アルバム作成のみ表示
**テスト手順:**
1. フィルターを「アルバム」に設定

**期待結果:**
- アルバム作成投稿のみ表示される

---

### 4.2 ユーザーフィルターのテスト

#### テストケース 4.2.1: フレンドのみ表示
**前提条件:**
- user1 がフレンド5人、ウォッチ3人を持つ

**テスト手順:**
1. フィルターを「フレンドのみ」に設定

**期待結果:**
- フレンドの投稿のみ表示される
- ウォッチ中のユーザーの投稿は非表示

#### テストケース 4.2.2: ウォッチ中のみ表示
**テスト手順:**
1. フィルターを「ウォッチ中」に設定

**期待結果:**
- ウォッチ中のユーザーの投稿のみ表示される
- フレンドの投稿は非表示（ウォッチもしている場合は表示）

---

## 5. ソート機能

### 5.1 並び順のテスト

#### テストケース 5.1.1: 新しい順（デフォルト）
**テスト手順:**
1. タイムラインを表示

**期待結果:**
- 投稿が新しい順（createdAt 降順）に並ぶ

#### テストケース 5.1.2: 人気順（いいね数）
**前提条件:**
- 投稿A: いいね5件
- 投稿B: いいね10件
- 投稿C: いいね2件

**テスト手順:**
1. ソートを「人気順」に変更

**期待結果:**
- 投稿が B → A → C の順に表示される

---

## 6. インタラクション機能

### 6.1 いいね機能のテスト

#### テストケース 6.1.1: タイムラインからいいね
**テスト手順:**
1. タイムライン上の投稿の「いいね」ボタンをクリック

**期待結果:**
- ボタンが「いいね済み」状態に変化
- いいね数が増加
- 投稿者に通知が送信される

#### テストケース 6.1.2: いいね解除
**前提条件:**
- 既にいいね済みの投稿

**テスト手順:**
1. 「いいね」ボタンをクリック

**期待結果:**
- ボタンが通常状態に戻る
- いいね数が減少

---

### 6.2 コメント機能のテスト

#### テストケース 6.2.1: タイムラインからコメント追加
**テスト手順:**
1. タイムライン上の投稿の「コメント」ボタンをクリック
2. コメント入力欄に「Nice photo!」と入力
3. 送信ボタンをクリック

**期待結果:**
- コメントが投稿される
- コメント数が増加
- コメント一覧に自分のコメントが表示される
- 投稿者に通知が送信される

#### テストケース 6.2.2: コメントの表示
**前提条件:**
- 投稿に5件のコメントが存在

**テスト手順:**
1. タイムライン上で投稿を確認

**期待結果:**
- 「コメント 5件」と表示される
- 最新2件のコメントがプレビュー表示される
- 「すべて見る」をクリックすると全コメント表示

---

## 7. パフォーマンステスト

### 7.1 読み込み速度のテスト

#### テストケース 7.1.1: 初回表示速度
**前提条件:**
- タイムラインに100件の投稿

**テスト手順:**
1. `/timeline` にアクセス
2. 初回表示時間を測定

**期待結果:**
- 初回表示が3秒以内
- 画像は遅延読み込みを使用

#### テストケース 7.1.2: スクロールパフォーマンス
**テスト手順:**
1. タイムラインを高速スクロール

**期待結果:**
- スクロールがスムーズ
- FPSが60に近い値を維持

#### テストケース 7.1.3: メモリ使用量
**前提条件:**
- 無限スクロールで200件の投稿を表示

**テスト手順:**
1. 200件まで読み込んでメモリ使用量を確認

**期待結果:**
- メモリリークがない
- 画面外の投稿は仮想スクロールで解放される（実装されている場合）

---

### 7.2 リアルタイムリスナーのテスト

#### テストケース 7.2.1: リスナーの接続数制限
**前提条件:**
- user1 が50人のフレンド・ウォッチを持つ

**テスト手順:**
1. タイムラインを表示
2. Firestore のリスナー数を確認

**期待結果:**
- リスナー数が適切に管理されている（最大1-2個）
- すべてのユーザーに対して個別リスナーを作成しない

#### テストケース 7.2.2: リスナーの切断
**テスト手順:**
1. タイムラインを表示
2. 別のページに遷移
3. Firestore リスナーを確認

**期待結果:**
- ページ離脱時にリスナーが切断される
- メモリリークがない

---

## 8. エラーハンドリング

### 8.1 ネットワークエラーのテスト

#### テストケース 8.1.1: 初回読み込み失敗
**テスト手順:**
1. ネットワークをオフラインにする
2. `/timeline` にアクセス

**期待結果:**
- エラーメッセージ「タイムラインを読み込めませんでした」
- リトライボタンが表示される

#### テストケース 8.1.2: 追加読み込み失敗
**テスト手順:**
1. タイムラインを表示
2. ネットワークをオフラインにする
3. スクロールして追加読み込みを試行

**期待結果:**
- エラーメッセージ「読み込みに失敗しました」
- リトライボタンが表示される

#### テストケース 8.1.3: オフライン→オンライン復帰
**テスト手順:**
1. オフライン状態でタイムラインにアクセス
2. ネットワークをオンラインに戻す
3. リトライボタンをクリック

**期待結果:**
- タイムラインが正常に読み込まれる

---

## 9. レスポンシブデザイン

### 9.1 モバイル表示のテスト

#### テストケース 9.1.1: スマートフォンでのタイムライン表示
**テスト手順:**
1. スマートフォン（375px幅）でタイムラインを表示

**期待結果:**
- 投稿が縦並びで表示される
- 画像が画面幅に収まる
- ボタンが押しやすいサイズ

#### テストケース 9.1.2: タブレットでのタイムライン表示
**テスト手順:**
1. タブレット（768px幅）でタイムラインを表示

**期待結果:**
- 2カラムまたは1カラムレイアウト
- 適切な余白とサイズ

---

## テスト環境

### 必要な環境
- ブラウザ: Chrome, Firefox, Safari, Edge
- デバイス: デスクトップ（1920x1080）、タブレット（768x1024）、スマートフォン（375x667）
- Firebase Emulator Suite

### テストデータ

```javascript
// テストタイムライン投稿
{
  id: "post1",
  type: "image", // または "album"
  userId: "user2",
  albumId: "album1",
  imageId: "image1",
  imageURL: "https://...",
  createdAt: new Date(),
  likeCount: 5,
  commentCount: 3
}

// テストユーザー関係
{
  user1: {
    friends: ["user2", "user3", "user4", "user5", "user6"],
    watching: ["user7", "user8", "user9"]
  }
}
```

---

## 自動テストの実装

### Jestテストケース例

```typescript
// lib/repos/__tests__/timelineRepo.test.ts

describe('timelineRepo', () => {
  describe('getTimelinePosts', () => {
    it('should return posts from friends and watched users', async () => {
      const posts = await getTimelinePosts('user1', 20);
      expect(posts.length).toBeLessThanOrEqual(20);
      expect(posts[0].createdAt).toBeInstanceOf(Date);
    });

    it('should return empty array when no friends', async () => {
      const posts = await getTimelinePosts('lonely-user', 20);
      expect(posts).toEqual([]);
    });

    it('should support pagination', async () => {
      const page1 = await getTimelinePosts('user1', 10);
      const lastPost = page1[page1.length - 1];
      const page2 = await getTimelinePosts('user1', 10, lastPost.createdAt);
      expect(page2[0].createdAt.getTime()).toBeLessThan(lastPost.createdAt.getTime());
    });
  });

  describe('likePost', () => {
    it('should like a post', async () => {
      await likePost('user1', 'post1');
      const like = await getLike('user1', 'post1');
      expect(like).toBeDefined();
    });

    it('should prevent duplicate likes', async () => {
      await likePost('user1', 'post1');
      await expect(
        likePost('user1', 'post1')
      ).rejects.toThrow();
    });
  });

  describe('addComment', () => {
    it('should add comment to post', async () => {
      const commentId = await addComment('user1', 'post1', 'Nice!');
      expect(commentId).toBeDefined();
    });

    it('should validate comment length', async () => {
      await expect(
        addComment('user1', 'post1', 'a'.repeat(501))
      ).rejects.toThrow();
    });
  });
});
```

---

## テスト完了チェックリスト

- [ ] タイムライン表示テストが通過
- [ ] 無限スクロールテストが通過
- [ ] リアルタイム更新テストが通過
- [ ] フィルタリングテストが通過
- [ ] ソートテストが通過
- [ ] いいね機能テストが通過
- [ ] コメント機能テストが通過
- [ ] パフォーマンステストが通過
- [ ] エラーハンドリングテストが通過
- [ ] レスポンシブテストが通過
- [ ] Firebase Emulator でのテスト完了
