# バックエンドテスト仕様: 認証API

## 概要
Firebase Authentication と Firestore を使用した認証関連のAPIエンドポイントとデータベース操作のテスト仕様。

---

## 1. ユーザー登録テスト

### 1.1 正常系
- **テスト**: 新規ユーザー登録
  - Firebase Auth でユーザー作成
  - Firestore の `users` コレクションにユーザードキュメント作成
  - 必須フィールド（displayName, handle, createdAt）が正しく保存される
  - レート制限（5分に1回）が適用される

- **テスト**: ユーザープロフィール初期値
  - bio が空文字列で作成される
  - iconURL がデフォルト値（null または空）
  - statsDoc が正しく初期化される（albums: 0, images: 0, followers: 0, following: 0）

### 1.2 異常系
- **テスト**: 重複ハンドルの防止
  - 既存の handle で登録を試みる
  - エラーが返される

- **テスト**: 無効なメールアドレス
  - 不正なメール形式で登録を試みる
  - Firebase Auth エラーが適切に処理される

- **テスト**: レート制限超過
  - 5分以内に2回登録を試みる
  - 2回目がブロックされる

---

## 2. 認証トークン検証テスト

### 2.1 正常系
- **テスト**: 有効なIDトークンの検証
  - Firebase Admin SDK の `verifyIdToken` が成功する
  - ユーザーIDが正しく抽出される

### 2.2 異常系
- **テスト**: 無効なトークン
  - 偽造されたトークンで検証を試みる
  - null が返される

- **テスト**: 期限切れトークン
  - 期限切れトークンで検証を試みる
  - 検証が失敗する

- **テスト**: トークンなし
  - トークンを送信せずにAPIを呼び出す
  - 401 Unauthorized が返される

---

## 3. ユーザー情報取得テスト

### 3.1 正常系
- **テスト**: ユーザー情報の取得
  - `userRepo.getUser(uid)` で正しいデータが取得できる
  - 存在しないユーザーIDの場合は null が返される

### 3.2 統合テスト
- **テスト**: 登録直後のユーザー情報取得
  - ユーザー登録後すぐに情報を取得
  - すべてのフィールドが正しく保存されていることを確認

---

## 4. アカウント削除テスト

### 4.1 正常系
- **テスト**: ユーザーデータの完全削除
  - `users` コレクションからドキュメント削除
  - 関連する `albums` の削除
  - 関連する `albumImages` の削除
  - 関連する `comments` の削除
  - 関連する `likes` の削除
  - 関連する `friends` の削除
  - 関連する `watches` の削除
  - 関連する `notifications` の削除
  - Firebase Auth からユーザー削除

### 4.2 異常系
- **テスト**: 削除中のエラーハンドリング
  - ネットワークエラー時のロールバック
  - 部分的な削除の検出と報告

---

## 5. セキュリティルールテスト

### 5.1 読み取り権限
- **テスト**: 公開プロフィールの読み取り
  - 未認証ユーザーが他のユーザーの公開情報を読める

- **テスト**: プライベート情報の保護
  - 他のユーザーのemail、プライベート設定が読めない

### 5.2 書き込み権限
- **テスト**: 自分のプロフィール更新
  - 認証ユーザーが自分のプロフィールを更新できる

- **テスト**: 他人のプロフィール更新防止
  - 他のユーザーのプロフィールを更新できない

---

## 6. パフォーマンステスト

### 6.1 負荷テスト
- **テスト**: 同時ユーザー登録
  - 10ユーザーが同時に登録
  - すべてのリクエストが正常に処理される

- **テスト**: 大量データ取得
  - 1000人のユーザーリストを取得
  - ページネーションが正しく機能する
