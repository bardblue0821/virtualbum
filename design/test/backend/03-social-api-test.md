# バックエンドテスト仕様: ソーシャル機能API

## 概要
フレンド申請、ウォッチ、いいね、コメント、リアクション、リポストなどのソーシャル機能に関するFirestore操作とAPIのテスト仕様。

---

## 1. フレンド申請テスト

### 1.1 正常系
- **テスト**: フレンド申請の送信
  - `friendRepo.sendFriendRequest()` で正しくドキュメント作成
  - `friends` コレクションに status: 'pending' で保存
  - ドキュメントID形式: `{userId}_{targetId}`
  - 通知が送信される

- **テスト**: フレンド申請の承認
  - `friendRepo.acceptFriend()` で status を 'accepted' に更新
  - 双方向の関係が確立される
  - 承認通知が送信される

- **テスト**: フレンド申請の拒否
  - 申請ドキュメントが削除される
  - 通知は送信されない

### 1.2 異常系
- **テスト**: 重複申請の防止
  - 既に申請中のユーザーに再度申請
  - エラーが返される

- **テスト**: 自分自身への申請防止
  - userId === targetId の場合
  - エラーが返される

- **テスト**: 既にフレンドのユーザーへの申請
  - status が 'accepted' のユーザーに申請
  - エラーが返される

---

## 2. フレンド関係取得テスト

### 2.1 正常系
- **テスト**: フレンドステータスの取得
  - `friendRepo.getFriendStatus()` が正しく動作
  - 'none', 'pending', 'accepted' を返す

- **テスト**: フレンドリストの取得
  - `friendRepo.listAcceptedFriends()` で承認済みフレンド取得
  - 双方向のクエリが正しく機能

### 2.2 異常系
- **テスト**: 存在しないユーザーのステータス取得
  - 'none' が返される

---

## 3. ウォッチ機能テスト

### 3.1 正常系
- **テスト**: ウォッチの追加
  - `watchRepo.addWatch()` で正しくドキュメント作成
  - `watches` コレクションに保存
  - ドキュメントID形式: `{userId}_{ownerId}`
  - 通知が送信される

- **テスト**: ウォッチの解除
  - `watchRepo.removeWatch()` でドキュメント削除

- **テスト**: ウォッチのトグル
  - `watchRepo.toggleWatch()` で追加/削除を切り替え

### 3.2 異常系
- **テスト**: 自分自身のウォッチ防止
  - userId === ownerId の場合
  - エラーが返される

- **テスト**: 重複ウォッチ防止
  - 既にウォッチしているユーザーを再度ウォッチ
  - エラーが返される

---

## 4. いいね機能テスト（POST /api/likes/toggle）

### 4.1 正常系
- **テスト**: いいねの追加
  - `adminToggleLike()` で `likes` コレクションにドキュメント作成
  - ドキュメントID形式: `{albumId}_{userId}`
  - いいね通知が送信される
  - レート制限（5分に10回）が適用される

- **テスト**: いいねの解除
  - 既存のいいねドキュメントが削除される

### 4.2 異常系
- **テスト**: 自分のアルバムへのいいね
  - 許可される（仕様による）

- **テスト**: プライベートアルバムへのいいね
  - オーナー以外がいいねできない
  - 403 Forbidden が返される

---

## 5. コメント機能テスト（POST /api/comments/add）

### 5.1 正常系
- **テスト**: コメントの投稿
  - `adminAddComment()` で `comments` コレクションにドキュメント作成
  - 必須フィールド（albumId, userId, body, createdAt）が保存される
  - コメント通知が送信される
  - レート制限（5分に5回）が適用される

- **テスト**: コメント文字数制限
  - 500文字まで投稿可能

### 5.2 異常系
- **テスト**: 空のコメント投稿防止
  - body が空文字列の場合
  - エラーが返される

- **テスト**: 文字数超過
  - 501文字以上のコメントを投稿
  - バリデーションエラーが返される

- **テスト**: プライベートアルバムへのコメント
  - オーナー以外がコメントできない
  - 403 Forbidden が返される

---

## 6. リアクション機能テスト（POST /api/reactions/toggle）

### 6.1 正常系
- **テスト**: リアクションの追加
  - `adminToggleReaction()` で `reactions` コレクションにドキュメント作成
  - ドキュメントID形式: `{albumId}_{userId}_{emoji}`
  - emoji（絵文字）が正しく保存される
  - レート制限（5分に15回）が適用される

- **テスト**: リアクションの解除
  - 既存のリアクションドキュメントが削除される

- **テスト**: リアクション集計
  - `reactionRepo.listReactionsByAlbum()` で絵文字ごとのカウント取得

### 6.2 異常系
- **テスト**: 無効な絵文字
  - 絵文字以外の文字列を送信
  - バリデーションエラーが返される

- **テスト**: 同じ絵文字の重複リアクション
  - トグルとして動作（削除される）

---

## 7. リポスト機能テスト（POST /api/reposts/toggle）

### 7.1 正常系
- **テスト**: リポストの追加
  - `adminToggleRepost()` で `reposts` コレクションにドキュメント作成
  - ドキュメントID形式: `{albumId}_{userId}`
  - リポスト通知が送信される

- **テスト**: リポストの解除
  - 既存のリポストドキュメントが削除される

### 7.2 異常系
- **テスト**: プライベートアルバムのリポスト防止
  - オーナー以外がリポストできない
  - 403 Forbidden が返される

---

## 8. 通知機能テスト

### 8.1 正常系
- **テスト**: 通知の作成
  - `notificationRepo.addNotification()` で正しくドキュメント作成
  - 必須フィールド（userId, actorId, type, message, read, createdAt）が保存される

- **テスト**: 通知リスト取得
  - `notificationRepo.listNotifications()` で最新100件取得
  - createdAt で降順ソート

- **テスト**: 未読数カウント
  - `notificationRepo.countUnread()` が正しく機能

- **テスト**: 全既読化
  - `notificationRepo.markAllRead()` で read: true に一括更新

### 8.2 異常系
- **テスト**: 自分への通知は作成されない
  - actorId === userId の場合
  - 通知が作成されない

---

## 9. 統合テスト

### 9.1 ワークフロー
- **テスト**: ソーシャルインタラクション完全フロー
  1. ユーザーAがユーザーBにフレンド申請
  2. ユーザーBが承認
  3. ユーザーAがアルバム作成
  4. ユーザーBがいいね
  5. ユーザーBがコメント投稿
  6. ユーザーBがリアクション追加
  7. ユーザーAが通知を確認
  8. すべての通知が正しく作成されていることを確認

### 9.2 同時操作
- **テスト**: 複数ユーザーの同時いいね
  - 10ユーザーが同じアルバムに同時にいいね
  - すべてのいいねが正しく記録される

---

## 10. レート制限テスト

### 10.1 各APIのレート制限
- **テスト**: いいね（10回/5分）
  - 5分間に11回いいねを試みる
  - 11回目がブロックされる

- **テスト**: コメント（5回/5分）
  - 5分間に6回コメントを試みる
  - 6回目がブロックされる

- **テスト**: リアクション（15回/5分）
  - 5分間に16回リアクションを試みる
  - 16回目がブロックされる

---

## 11. パフォーマンステスト

### 11.1 負荷テスト
- **テスト**: 大量コメント取得
  - 1つのアルバムに1000件のコメント
  - ページネーションで取得

- **テスト**: 大量通知取得
  - 1000件の通知から最新100件を取得
  - 1秒以内にレスポンスが返る

---

## 12. セキュリティテスト

### 12.1 認証
- **テスト**: 未認証ユーザーのいいね防止
  - トークンなしでいいねを試みる
  - 401 Unauthorized が返される

### 12.2 認可
- **テスト**: 他人になりすましたコメント防止
  - トークンと異なるuserIdでコメント投稿
  - 403 Forbidden が返される
