# バックエンドテスト仕様: データベース統合テスト

## 概要
複雑なクエリ、トランザクション、データ整合性、カスケード削除など、データベース層の統合テストとFirestoreの高度な機能のテスト仕様。

---

## 1. トランザクションテスト

### 1.1 正常系
- **テスト**: アトミックな更新
  - いいね追加時にアルバムのlikesCountを同時に更新
  - すべての更新が成功する、または全てロールバックされる

- **テスト**: バッチ書き込み
  - `writeBatch()` を使用して複数ドキュメントを一括作成
  - すべてのドキュメントが正しく作成される

### 1.2 異常系
- **テスト**: トランザクション競合
  - 2つのトランザクションが同じドキュメントを同時に更新
  - 片方が失敗してリトライされる

- **テスト**: トランザクション失敗時のロールバック
  - 途中でエラーが発生した場合
  - すべての変更がロールバックされる

---

## 2. カスケード削除テスト

### 2.1 ユーザー削除時
- **テスト**: ユーザー削除時の関連データクリーンアップ
  - `deleteAccountData()` で以下がすべて削除される：
    1. `users` ドキュメント
    2. 所有する `albums`
    3. 所有する `albumImages`
    4. 投稿した `comments`
    5. `likes` （送信・受信の両方）
    6. `friends` （両方向）
    7. `watches` （送信・受信の両方）
    8. `notifications` （送信・受信の両方）
    9. `reactions`
    10. `reposts`
  - Firebase Auth からも削除される

### 2.2 アルバム削除時
- **テスト**: アルバム削除時の関連データクリーンアップ
  - `albumRepo.deleteAlbum()` で以下がすべて削除される：
    1. アルバムドキュメント
    2. すべての `albumImages`
    3. すべての `comments`
    4. すべての `likes`
    5. すべての `reactions`
    6. すべての `reposts`
    7. 関連する `notifications`
    8. Storage から画像ファイル

### 2.3 異常系
- **テスト**: 削除中のエラー
  - 削除途中でネットワークエラーが発生
  - 残ったデータの検出と再試行

---

## 3. 複雑なクエリテスト

### 3.1 複合クエリ
- **テスト**: タイムラインフィルタリング
  - フレンドのアルバムのみ取得
  - ウォッチしているユーザーのアルバムのみ取得
  - 公開アルバムのみ取得
  - 複数条件の組み合わせ

- **テスト**: ページネーション
  - `startAfter()` を使用して次のページ取得
  - 重複なく取得できる

### 3.2 集約クエリ
- **テスト**: ユーザー統計の集計
  - アルバム数カウント
  - 画像数カウント
  - フォロワー数カウント
  - フォロー中カウント

### 3.3 N+1問題の回避
- **テスト**: バッチクエリの効率化
  - `batchQuery.getUsersBatch()` で複数ユーザーを一括取得
  - 10件ごとにチャンク分割して取得
  - 個別クエリの繰り返しを回避

---

## 4. データ整合性テスト

### 4.1 正常系
- **テスト**: フレンド関係の双方向性
  - ユーザーAがユーザーBにフレンド申請
  - 承認後、両方向から関係が確認できる

- **テスト**: カウンタの整合性
  - いいねを追加したらlikesCountが増える
  - いいねを削除したらlikesCountが減る
  - 実際のlikesドキュメント数と一致する

### 4.2 異常系
- **テスト**: 孤立したデータの検出
  - 存在しないアルバムへのコメント
  - 存在しないユーザーへのフレンド申請
  - データベース整合性チェッカーで検出

---

## 5. リアルタイム更新テスト

### 5.1 正常系
- **テスト**: Firestore リスナー
  - `onSnapshot()` で通知の変更を監視
  - 新しい通知が追加されたらリアルタイムで受信
  - 通知が既読になったらリアルタイムで更新

- **テスト**: 複数クライアントの同期
  - クライアントAがいいねを追加
  - クライアントBの画面がリアルタイムで更新される

### 5.2 異常系
- **テスト**: 接続切断時の挙動
  - ネットワーク切断中に変更が発生
  - 再接続後に変更が同期される

---

## 6. セキュリティルールテスト

### 6.1 読み取りルール
- **テスト**: 公開データの読み取り
  - 未認証ユーザーが公開アルバムを読める
  - 公開プロフィールを読める

- **テスト**: プライベートデータの保護
  - 他人のプライベートアルバムを読めない
  - 他人のメールアドレスを読めない
  - フレンド限定アルバムは非フレンドが読めない

### 6.2 書き込みルール
- **テスト**: 自分のデータの更新
  - 認証ユーザーが自分のプロフィールを更新できる
  - 自分のアルバムを削除できる

- **テスト**: 他人のデータの保護
  - 他人のプロフィールを更新できない
  - 他人のアルバムを削除できない
  - 他人のコメントを削除できない

### 6.3 検証ルール
- **テスト**: データバリデーション
  - 必須フィールドがないと作成できない
  - 文字数制限を超えると作成できない
  - 不正な型のデータを作成できない

---

## 7. パフォーマンステスト

### 7.1 インデックス最適化
- **テスト**: 複合インデックスの動作確認
  - `albums` コレクションで ownerId + createdAt のクエリ
  - インデックスが正しく使用される
  - クエリが高速（100ms以内）

- **テスト**: ページネーションのパフォーマンス
  - 10,000件のアルバムから50件ずつ取得
  - 各ページが500ms以内に返る

### 7.2 読み取り回数の最適化
- **テスト**: 1回のリクエストでの読み取り回数
  - タイムライン表示で最小限の読み取り
  - キャッシュの活用

---

## 8. エラーハンドリングテスト

### 8.1 ネットワークエラー
- **テスト**: ネットワーク切断時の挙動
  - Firestore操作中にネットワークが切断
  - 適切なエラーが返される
  - オフラインキャッシュが使用される

### 8.2 権限エラー
- **テスト**: セキュリティルール違反
  - 不正なアクセスでpermission-deniedエラー
  - クライアントで適切にハンドリングされる

### 8.3 クォータ超過
- **テスト**: レート制限超過
  - 1秒間に100回のリクエスト
  - 適切にスロットリングされる

---

## 9. データマイグレーションテスト

### 9.1 スキーマ変更
- **テスト**: 新しいフィールドの追加
  - 既存ドキュメントに新しいフィールドを追加
  - 既存データが壊れない

- **テスト**: フィールド名の変更
  - displayNameをuserNameに変更（例）
  - 旧データも正しく読める

### 9.2 バックフィル
- **テスト**: 既存データの一括更新
  - すべてのユーザーに新しいフィールドを追加
  - バッチ処理で効率的に実行

---

## 10. バックアップ・リストアテスト

### 10.1 バックアップ
- **テスト**: データのエクスポート
  - Firestoreデータを完全にエクスポート
  - すべてのコレクションが含まれる

### 10.2 リストア
- **テスト**: データのインポート
  - エクスポートしたデータをインポート
  - データが正しく復元される

---

## 11. 監査ログテスト

### 11.1 操作履歴
- **テスト**: 重要な操作の記録
  - ユーザー登録
  - アルバム削除
  - アカウント削除
  - ログコレクションに記録される

### 11.2 ログ検索
- **テスト**: ユーザーの操作履歴取得
  - 特定ユーザーのすべての操作を取得
  - 時系列で表示
