# バックエンドテスト仕様: APIエンドポイント統合テスト

## 概要
Next.js API Routes（/api/*）のHTTPリクエスト・レスポンス、認証、エラーハンドリング、レート制限などのテスト仕様。

---

## 1. 画像登録API（POST /api/images/register）

### 1.1 正常系
- **テスト**: 画像の正常登録
  - リクエスト:
    ```json
    {
      "albumId": "album123",
      "url": "https://...",
      "thumbUrl": "https://...",
      "token": "valid-firebase-token"
    }
    ```
  - レスポンス: 200 OK
  - Firestoreに正しく保存される

### 1.2 異常系
- **テスト**: 認証トークンなし
  - レスポンス: 401 Unauthorized

- **テスト**: 無効なトークン
  - レスポンス: 401 Unauthorized

- **テスト**: 存在しないアルバムID
  - レスポンス: 404 Not Found

- **テスト**: フレンド限定アルバムへの不正アクセス
  - レスポンス: 403 Forbidden

- **テスト**: 画像枚数上限超過
  - レスポンス: 400 Bad Request
  - メッセージ: "最大100枚まで"

- **テスト**: レート制限超過（20回/分）
  - レスポンス: 429 Too Many Requests

---

## 2. 画像削除API（POST /api/images/delete）

### 2.1 正常系
- **テスト**: 画像の正常削除
  - リクエスト:
    ```json
    {
      "imageId": "image123",
      "token": "valid-firebase-token"
    }
    ```
  - レスポンス: 200 OK
  - Firestoreから削除される
  - Storageからも削除される

### 2.2 異常系
- **テスト**: 他人の画像削除試行
  - レスポンス: 403 Forbidden

- **テスト**: 存在しない画像ID
  - レスポンス: 404 Not Found

---

## 3. コメント追加API（POST /api/comments/add）

### 3.1 正常系
- **テスト**: コメントの正常投稿
  - リクエスト:
    ```json
    {
      "albumId": "album123",
      "body": "素敵な写真ですね！",
      "token": "valid-firebase-token"
    }
    ```
  - レスポンス: 200 OK
  - Firestoreに保存される
  - 通知が送信される

### 3.2 異常系
- **テスト**: 空のコメント
  - レスポンス: 400 Bad Request

- **テスト**: 501文字以上のコメント
  - レスポンス: 400 Bad Request

- **テスト**: プライベートアルバムへのコメント
  - レスポンス: 403 Forbidden

- **テスト**: レート制限超過（10回/分）
  - レスポンス: 429 Too Many Requests

---

## 4. いいねトグルAPI（POST /api/likes/toggle）

### 4.1 正常系
- **テスト**: いいねの追加
  - リクエスト:
    ```json
    {
      "albumId": "album123",
      "token": "valid-firebase-token"
    }
    ```
  - レスポンス: 200 OK
  - レスポンスボディ: `{ "added": true }`

- **テスト**: いいねの削除
  - 同じリクエストを2回送信
  - 2回目のレスポンス: `{ "removed": true }`

### 4.2 異常系
- **テスト**: レート制限超過（10回/分）
  - レスポンス: 429 Too Many Requests

---

## 5. リアクショントグルAPI（POST /api/reactions/toggle）

### 5.1 正常系
- **テスト**: リアクションの追加
  - リクエスト:
    ```json
    {
      "albumId": "album123",
      "emoji": "👍",
      "token": "valid-firebase-token"
    }
    ```
  - レスポンス: 200 OK
  - レスポンスボディ: `{ "added": true }`

### 5.2 異常系
- **テスト**: 無効な絵文字
  - レスポンス: 400 Bad Request

- **テスト**: レート制限超過（20回/分）
  - レスポンス: 429 Too Many Requests

---

## 6. リポストトグルAPI（POST /api/reposts/toggle）

### 6.1 正常系
- **テスト**: リポストの追加
  - リクエスト:
    ```json
    {
      "albumId": "album123",
      "token": "valid-firebase-token"
    }
    ```
  - レスポンス: 200 OK
  - レスポンスボディ: `{ "added": true }`

### 6.2 異常系
- **テスト**: プライベートアルバムのリポスト
  - レスポンス: 403 Forbidden

---

## 7. アルバム通報API（POST /api/reports/album）

### 7.1 正常系
- **テスト**: 通報の送信
  - リクエスト:
    ```json
    {
      "albumId": "album123",
      "reason": "不適切なコンテンツ",
      "token": "valid-firebase-token"
    }
    ```
  - レスポンス: 200 OK
  - 管理者にメール通知が送信される

### 7.2 異常系
- **テスト**: レート制限超過（5回/分）
  - レスポンス: 429 Too Many Requests

- **テスト**: 理由が空
  - レスポンス: 400 Bad Request

---

## 8. レート制限テスト

### 8.1 各エンドポイントのレート制限
- **テスト**: /api/images/register（20回/分）
  - 1分間に21回リクエスト
  - 21回目が429エラー

- **テスト**: /api/comments/add（10回/分）
  - 1分間に11回リクエスト
  - 11回目が429エラー

- **テスト**: /api/likes/toggle（10回/分）
  - 1分間に11回リクエスト
  - 11回目が429エラー

- **テスト**: /api/reactions/toggle（20回/分）
  - 1分間に21回リクエスト
  - 21回目が429エラー

- **テスト**: /api/reports/album（5回/分）
  - 1分間に6回リクエスト
  - 6回目が429エラー

### 8.2 IPベースのレート制限
- **テスト**: 同一IPからの大量リクエスト
  - 異なるアカウントでも同一IPなら制限される

- **テスト**: リセット時間後のアクセス
  - 1分経過後、再びアクセス可能

---

## 9. HTTPメソッド制限テスト

### 9.1 正常系
- **テスト**: POSTリクエストのみ許可
  - すべてのAPIがPOSTのみ受け付ける

### 9.2 異常系
- **テスト**: GETリクエスト
  - レスポンス: 405 Method Not Allowed

- **テスト**: PUTリクエスト
  - レスポンス: 405 Method Not Allowed

- **テスト**: DELETEリクエスト
  - レスポンス: 405 Method Not Allowed

---

## 10. CORSテスト

### 10.1 正常系
- **テスト**: 同一オリジンからのリクエスト
  - 正常に処理される

### 10.2 異常系（設定による）
- **テスト**: 外部オリジンからのリクエスト
  - CORSヘッダーが適切に設定される
  - またはブロックされる（設定次第）

---

## 11. エラーレスポンス形式テスト

### 11.1 標準化されたエラー形式
- **テスト**: すべてのエラーが統一形式
  ```json
  {
    "error": "エラーメッセージ",
    "code": "ERROR_CODE"
  }
  ```

### 11.2 各種エラーコード
- **テスト**: 400 Bad Request
  - バリデーションエラー

- **テスト**: 401 Unauthorized
  - 認証エラー

- **テスト**: 403 Forbidden
  - 認可エラー

- **テスト**: 404 Not Found
  - リソースが存在しない

- **テスト**: 429 Too Many Requests
  - レート制限超過

- **テスト**: 500 Internal Server Error
  - サーバーエラー

---

## 12. セキュリティテスト

### 12.1 認証
- **テスト**: Authorizationヘッダーの検証
  - `Bearer {token}` 形式のトークン
  - 無効な形式は拒否される

### 12.2 入力検証
- **テスト**: SQLインジェクション対策
  - 悪意のある入力が安全に処理される

- **テスト**: XSS対策
  - スクリプトタグがエスケープされる

- **テスト**: パストラバーサル対策
  - `../../etc/passwd` のような入力が拒否される

---

## 13. 統合テスト

### 13.1 エンドツーエンドフロー
- **テスト**: 画像アップロードからコメントまで
  1. POST /api/images/register で画像登録
  2. POST /api/comments/add でコメント追加
  3. POST /api/likes/toggle でいいね
  4. POST /api/reactions/toggle でリアクション
  5. すべてが正しく連携して動作

---

## 14. パフォーマンステスト

### 14.1 レスポンスタイム
- **テスト**: 各APIのレスポンスタイム
  - 通常時: 500ms以内
  - 高負荷時: 2秒以内

### 14.2 同時接続
- **テスト**: 100ユーザーの同時リクエスト
  - すべてのリクエストが正常に処理される
  - タイムアウトが発生しない
