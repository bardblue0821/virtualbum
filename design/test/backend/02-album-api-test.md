# バックエンドテスト仕様: アルバムAPI

## 概要
アルバム作成・編集・削除および画像管理に関するFirestore操作とAPIエンドポイントのテスト仕様。

---

## 1. アルバム作成テスト

### 1.1 正常系
- **テスト**: 新規アルバム作成
  - `albumRepo.createAlbum()` で正しくドキュメント作成
  - 必須フィールド（title, ownerId, visibility, createdAt）が保存される
  - アルバムIDが正しく生成される
  - レート制限（5分に3回）が適用される

- **テスト**: アルバム数上限チェック
  - ユーザーごとに最大4つまで作成可能
  - 5つ目の作成が拒否される

### 1.2 異常系
- **テスト**: 必須フィールド不足
  - title なしで作成を試みる
  - エラーが返される

- **テスト**: タイトル長制限
  - 101文字以上のタイトルで作成を試みる
  - バリデーションエラーが返される

- **テスト**: 説明文字数制限
  - 1001文字以上の説明で作成を試みる
  - バリデーションエラーが返される

- **テスト**: 無効な公開範囲
  - public/friends/private 以外の値を設定
  - エラーが返される

---

## 2. アルバム更新テスト

### 2.1 正常系
- **テスト**: アルバム情報の更新
  - `albumRepo.updateAlbum()` で title, description, visibility を更新
  - 更新日時が正しく記録される

### 2.2 異常系
- **テスト**: 他人のアルバム更新防止
  - 別ユーザーがアルバムを更新しようとする
  - 403 Forbidden が返される

- **テスト**: 存在しないアルバムの更新
  - 無効なアルバムIDで更新を試みる
  - 404 Not Found が返される

---

## 3. アルバム削除テスト

### 3.1 正常系
- **テスト**: アルバムとすべての関連データ削除
  - `albumRepo.deleteAlbum()` で以下を削除：
    - アルバムドキュメント
    - すべての画像（`albumImages` サブコレクション）
    - すべてのコメント
    - すべてのいいね
    - すべてのリアクション
  - Storage から画像ファイルも削除される

### 3.2 異常系
- **テスト**: 他人のアルバム削除防止
  - 別ユーザーがアルバムを削除しようとする
  - 403 Forbidden が返される

---

## 4. 画像アップロードテスト

### 4.1 正常系
- **テスト**: 画像の追加（POST /api/images/register）
  - Storage にアップロード済みの画像を Firestore に登録
  - `albumImages` コレクションにドキュメント作成
  - url, thumbUrl, uploaderId, albumId が正しく保存される
  - レート制限（5分に10回）が適用される

- **テスト**: 画像枚数カウント
  - `imageRepo.canUploadMoreImages()` が正しく機能
  - アルバムあたり最大100枚まで

### 4.2 異常系
- **テスト**: 画像枚数上限超過
  - 101枚目の画像追加を試みる
  - エラーが返される

- **テスト**: 無効なアルバムIDで画像追加
  - 存在しないアルバムに画像を追加
  - 404 Not Found が返される

- **テスト**: 画像サイズ制限（クライアント側で制御済みだが念のため）
  - 5MB超過の画像アップロードを試みる
  - エラーが返される

- **テスト**: フレンド限定アルバムへのアクセス
  - フレンドでないユーザーが画像追加を試みる
  - 403 Forbidden が返される

---

## 5. 画像削除テスト

### 5.1 正常系
- **テスト**: 画像の削除（POST /api/images/delete）
  - `adminDeleteImage()` で Firestore ドキュメント削除
  - Storage から画像ファイルも削除される

### 5.2 異常系
- **テスト**: 他人の画像削除防止
  - アルバムオーナー以外が削除を試みる
  - 403 Forbidden が返される

---

## 6. アルバム取得テスト

### 6.1 正常系
- **テスト**: タイムライン取得
  - `albumRepo.getLatestAlbums()` で最新50件取得
  - createdAt で降順ソート

- **テスト**: ユーザー別アルバム一覧
  - `albumRepo.listAlbumsByOwner()` で特定ユーザーのアルバム取得
  - 最大100件まで

- **テスト**: 公開範囲フィルタリング
  - public: すべてのユーザーが閲覧可能
  - friends: フレンドのみ閲覧可能
  - private: オーナーのみ閲覧可能

### 6.2 異常系
- **テスト**: プライベートアルバムへの不正アクセス
  - 他ユーザーがプライベートアルバムを閲覧しようとする
  - アクセス拒否される

---

## 7. 公開範囲・権限テスト

### 7.1 正常系
- **テスト**: 公開アルバムの閲覧
  - 未認証ユーザーでも閲覧可能

- **テスト**: フレンド限定アルバム
  - フレンドのみが閲覧可能
  - `getFriendStatus()` が正しく動作

- **テスト**: プライベートアルバム
  - オーナーのみが閲覧可能

### 7.2 異常系
- **テスト**: 非フレンドのアクセス
  - フレンド限定アルバムに非フレンドがアクセス
  - 403 Forbidden が返される

---

## 8. 統合テスト

### 8.1 ワークフロー
- **テスト**: アルバム作成から削除までの完全フロー
  1. アルバム作成
  2. 画像3枚アップロード
  3. タイトル変更
  4. 公開範囲変更
  5. 画像1枚削除
  6. アルバム全体削除
  7. すべてのデータが正しく削除されたことを確認

### 8.2 同時操作
- **テスト**: 複数ユーザーの同時アルバム作成
  - 10ユーザーが同時にアルバム作成
  - すべてのリクエストが正常に処理される

---

## 9. パフォーマンステスト

### 9.1 負荷テスト
- **テスト**: 大量画像アップロード
  - 1つのアルバムに100枚の画像を連続アップロード
  - すべての画像が正しく登録される

- **テスト**: 大量アルバム取得
  - 1000個のアルバムから最新50件を取得
  - 1秒以内にレスポンスが返る

---

## 10. セキュリティテスト

### 10.1 認証
- **テスト**: 未認証ユーザーのアルバム作成防止
  - トークンなしで作成を試みる
  - 401 Unauthorized が返される

### 10.2 認可
- **テスト**: SQLインジェクション対策
  - 悪意のあるalbuIdを送信
  - 安全に処理される

- **テスト**: XSS対策
  - スクリプトタグを含むタイトルで作成
  - エスケープされて保存される
