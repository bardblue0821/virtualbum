# パフォーマンス最適化 テスト仕様書

## テスト対象
- ページ読み込み速度
- 画像最適化
- Firestoreクエリ最適化
- リアルタイムリスナー管理
- メモリ使用量

---

## 1. ページ読み込み速度

### 1.1 初回読み込みのテスト

#### テストケース 1.1.1: トップページの読み込み速度
**テスト手順:**
1. キャッシュをクリア
2. トップページ `/` にアクセス
3. Lighthouse でパフォーマンスを測定

**期待結果:**
- パフォーマンススコア: 90以上
- FCP（First Contentful Paint）: 1.8秒以内
- LCP（Largest Contentful Paint）: 2.5秒以内
- TTI（Time to Interactive）: 3.8秒以内
- CLS（Cumulative Layout Shift）: 0.1以下

#### テストケース 1.1.2: タイムラインの読み込み速度
**前提条件:**
- タイムラインに100件の投稿が存在

**テスト手順:**
1. `/timeline` にアクセス
2. 読み込み時間を測定

**期待結果:**
- 初回表示: 3秒以内
- 最初の20件のみ読み込む
- 画像は遅延読み込み

---

### 1.2 キャッシュ効果のテスト

#### テストケース 1.2.1: 2回目以降の読み込み
**テスト手順:**
1. ページを訪問
2. ページをリロード
3. 読み込み時間を比較

**期待結果:**
- 2回目は1秒以内で表示
- Service Worker によるキャッシュが効く

---

## 2. 画像最適化

### 2.1 画像サイズ最適化のテスト

#### テストケース 2.1.1: 適切なサイズの画像配信
**テスト手順:**
1. アルバムグリッドを表示
2. ネットワークタブで読み込まれる画像を確認

**期待結果:**
- グリッド表示: 128px サムネイルが使用される
- 拡大表示: 1024px 画像が使用される
- 元画像は読み込まれない

#### テストケース 2.1.2: 遅延読み込み（Lazy Loading）
**テスト手順:**
1. 100枚の画像があるアルバムを表示
2. ネットワークタブで読み込みを確認

**期待結果:**
- 画面外の画像は最初読み込まれない
- スクロールに応じて画像が読み込まれる
- Intersection Observer が使用される

#### テストケース 2.1.3: WebP形式の使用
**テスト手順:**
1. 画像を確認

**期待結果:**
- WebP対応ブラウザではWebP形式が配信される
- 非対応ブラウザではJPEGにフォールバック

---

## 3. Firestoreクエリ最適化

### 3.1 N+1問題の解消テスト

#### テストケース 3.1.1: タイムライン読み込み時のクエリ数
**前提条件:**
- タイムラインに20件の投稿（10人のユーザー）

**テスト手順:**
1. タイムラインを表示
2. Firestore のクエリ数を確認

**期待結果:**
- クエリ数: 3回以内
  - タイムライン投稿取得: 1回
  - ユーザー情報取得（バッチ化）: 1回
  - いいね・コメント数取得（バッチ化）: 1回
- N+1問題が発生しない

#### テストケース 3.1.2: アルバム一覧読み込み時のクエリ数
**前提条件:**
- プロフィールに20個のアルバム

**テスト手順:**
1. プロフィールページのアルバムタブを表示
2. クエリ数を確認

**期待結果:**
- クエリ数: 1-2回
- アルバム情報をまとめて取得

---

### 3.2 インデックス活用のテスト

#### テストケース 3.2.1: 複合インデックスの使用
**テスト手順:**
1. タイムラインを `createdAt` でソートして取得
2. Firestore コンソールでインデックス使用を確認

**期待結果:**
- 複合インデックスが使用される
- インデックス未作成エラーが発生しない

---

## 4. リアルタイムリスナー管理

### 4.1 リスナー数の制限テスト

#### テストケース 4.1.1: タイムラインのリスナー数
**前提条件:**
- user1 が50人のフレンド・ウォッチを持つ

**テスト手順:**
1. タイムラインを表示
2. アクティブなリスナー数を確認

**期待結果:**
- リスナー数: 1-2個
- すべてのユーザーに対して個別リスナーを作成しない

#### テストケース 4.1.2: リスナーの切断
**テスト手順:**
1. タイムラインを表示
2. 別のページに遷移
3. リスナーの状態を確認

**期待結果:**
- ページ離脱時にリスナーが切断される
- メモリリークがない

---

## 5. メモリ使用量

### 5.1 メモリリークのテスト

#### テストケース 5.1.1: 長時間使用時のメモリ使用量
**テスト手順:**
1. アプリを30分間使用（ページ遷移を繰り返す）
2. Chrome DevTools でメモリスナップショットを取得

**期待結果:**
- メモリ使用量が一定範囲内に収まる
- リスナーやイベントリスナーが適切に解放される

#### テストケース 5.1.2: 無限スクロールのメモリ管理
**テスト手順:**
1. タイムラインを200件分スクロール
2. メモリ使用量を確認

**期待結果:**
- メモリ使用量が過度に増加しない
- 仮想スクロールにより画面外の要素が解放される（実装されている場合）

---

## 6. バンドルサイズ最適化

### 6.1 JavaScriptバンドルサイズのテスト

#### テストケース 6.1.1: 初回バンドルサイズ
**テスト手順:**
1. プロダクションビルドを実行
2. バンドルサイズを確認

**期待結果:**
- 初回バンドル（gzip後）: 200KB以下
- Code Splitting が適用されている
- 未使用コードが含まれていない

#### テストケース 6.1.2: 動的インポート
**テスト手順:**
1. 各ページに遷移
2. ネットワークタブで読み込まれるJSファイルを確認

**期待結果:**
- ページごとにチャンク分割されている
- 必要なコードのみが読み込まれる

---

## 7. データベース読み取り回数の削減

### 7.1 キャッシュ活用のテスト

#### テストケース 7.1.1: ユーザー情報のキャッシュ
**テスト手順:**
1. タイムラインを表示
2. 同じユーザーの投稿が複数ある場合のクエリ数を確認

**期待結果:**
- 同じユーザー情報を複数回取得しない
- メモリキャッシュまたは状態管理でキャッシュされる

---

## 8. レンダリングパフォーマンス

### 8.1 再レンダリング最適化のテスト

#### テストケース 8.1.1: 不要な再レンダリングの防止
**テスト手順:**
1. React DevTools Profiler で再レンダリングを記録
2. 親コンポーネントの状態を変更

**期待結果:**
- `React.memo` により不要な再レンダリングが防止される
- 変更されたコンポーネントのみ再レンダリング

---

## テスト環境

### 必要な環境
- ブラウザ: Chrome（DevTools使用）
- ツール: Lighthouse, Chrome DevTools Profiler, Network タブ
- Firebase Emulator Suite

---

## 自動テストの実装

### パフォーマンステスト例

```typescript
// __tests__/performance.test.ts

describe('Performance tests', () => {
  it('should load timeline within 3 seconds', async () => {
    const startTime = performance.now();
    await page.goto('http://localhost:3000/timeline');
    await page.waitForSelector('[data-testid="timeline-post"]');
    const endTime = performance.now();
    const loadTime = endTime - startTime;
    expect(loadTime).toBeLessThan(3000);
  });

  it('should lazy load images', async () => {
    await page.goto('http://localhost:3000/album/test-album');
    const images = await page.$$('img[loading="lazy"]');
    expect(images.length).toBeGreaterThan(0);
  });

  it('should limit Firestore queries', async () => {
    // Firebase Emulator でクエリ数をカウント
    const queryCount = await getFirestoreQueryCount();
    expect(queryCount).toBeLessThan(5);
  });
});
```

---

## 最適化チェックリスト

- [ ] Lighthouse スコア 90以上達成
- [ ] FCP 1.8秒以内
- [ ] LCP 2.5秒以内
- [ ] CLS 0.1以下
- [ ] 画像遅延読み込み実装済み
- [ ] WebP形式使用
- [ ] N+1問題解消
- [ ] リアルタイムリスナー数制限
- [ ] メモリリーク無し
- [ ] バンドルサイズ 200KB以下
- [ ] Code Splitting 実装済み
