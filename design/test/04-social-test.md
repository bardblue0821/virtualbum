# ソーシャル機能 テスト仕様書

## テスト対象
- フレンド機能（申請・承認・拒否・削除）
- ウォッチ機能（フォロー・アンフォロー）
- フレンド一覧・ウォッチ一覧の表示

---

## 1. フレンド申請機能

### 1.1 フレンド申請のテスト

#### テストケース 1.1.1: フレンド申請の送信
**前提条件:**
- user1 でログイン済み
- user2 が存在し、フレンド関係ではない

**テスト手順:**
1. `/user/user2` にアクセス
2. 「フレンド申請」ボタンをクリック

**期待結果:**
- ボタンが「申請中」に変化
- 成功メッセージ「フレンド申請を送信しました」
- Firestore `friends` コレクションに以下のドキュメントが作成される:
  - `friends/{user1_user2}`: `{ from: user1, to: user2, status: "pending" }`
- user2 に通知が送信される

#### テストケース 1.1.2: 重複申請の防止
**前提条件:**
- user1 から user2 へ既に申請中（pending）

**テスト手順:**
1. `/user/user2` にアクセス
2. ボタンの状態を確認

**期待結果:**
- ボタンは「申請中」と表示され、無効化されている
- 再度申請はできない

#### テストケース 1.1.3: 自分自身へのフレンド申請
**テスト手順:**
1. 自分のプロフィールページにアクセス

**期待結果:**
- フレンド申請ボタンは表示されない

#### テストケース 1.1.4: 未ログイン状態での申請試行
**テスト手順:**
1. ログアウト
2. `/user/user2` にアクセス
3. フレンド申請ボタンをクリック

**期待結果:**
- `/login` にリダイレクト

---

### 1.2 フレンド申請の承認・拒否テスト

#### テストケース 1.2.1: フレンド申請の承認
**前提条件:**
- user1 から user2 へフレンド申請済み（pending）
- user2 でログイン

**テスト手順:**
1. 通知欄またはフレンド申請一覧ページでuser1からの申請を確認
2. 「承認」ボタンをクリック

**期待結果:**
- 成功メッセージ「フレンドになりました」
- `friends/{user1_user2}` の status が "accepted" に更新
- `friends/{user2_user1}` に同じく status: "accepted" のドキュメントが作成
- user1 に承認通知が送信される
- お互いのフレンド一覧に表示される

#### テストケース 1.2.2: フレンド申請の拒否
**前提条件:**
- user1 から user2 へフレンド申請済み（pending）
- user2 でログイン

**テスト手順:**
1. フレンド申請一覧で user1 からの申請を確認
2. 「拒否」ボタンをクリック

**期待結果:**
- `friends/{user1_user2}` が削除される
- user1 には通知は送られない
- user1 のプロフィールページで再度申請可能になる

#### テストケース 1.2.3: 他人の申請を承認・拒否する試み
**前提条件:**
- user1 から user2 へ申請済み
- user3 でログイン

**テスト手順:**
1. user3 でuser1→user2の申請を承認しようと試みる

**期待結果:**
- エラーまたはアクセス拒否
- Firestore Rules により操作が拒否される

---

## 2. フレンド削除機能

### 2.1 フレンド関係の解除テスト

#### テストケース 2.1.1: フレンドの削除
**前提条件:**
- user1 と user2 がフレンド関係（accepted）

**テスト手順:**
1. user1 でフレンド一覧を開く
2. user2 の「削除」ボタンをクリック
3. 確認ダイアログで「削除」を選択

**期待結果:**
- 成功メッセージ「フレンドを削除しました」
- `friends/{user1_user2}` と `friends/{user2_user1}` が削除される
- お互いのフレンド一覧から消える
- user2 には通知は送られない

#### テストケース 2.1.2: フレンド削除のキャンセル
**テスト手順:**
1. 「削除」ボタンをクリック
2. 確認ダイアログで「キャンセル」を選択

**期待結果:**
- フレンド関係は維持される

---

## 3. ウォッチ機能

### 3.1 ウォッチ（フォロー）のテスト

#### テストケース 3.1.1: ユーザーをウォッチ
**前提条件:**
- user1 でログイン
- user2 が存在し、user1 は user2 をウォッチしていない

**テスト手順:**
1. `/user/user2` にアクセス
2. 「ウォッチ」ボタンをクリック

**期待結果:**
- ボタンが「ウォッチ中」に変化
- 成功メッセージ「ウォッチを開始しました」
- `watches/{user1_user2}` ドキュメントが作成される:
  - `{ watcherId: user1, watchedId: user2, createdAt: timestamp }`
- user2 のウォッチャー数が増加

#### テストケース 3.1.2: ウォッチの解除（アンウォッチ）
**前提条件:**
- user1 が user2 をウォッチ中

**テスト手順:**
1. `/user/user2` にアクセス
2. 「ウォッチ中」ボタンをクリック

**期待結果:**
- ボタンが「ウォッチ」に戻る
- 成功メッセージ「ウォッチを解除しました」
- `watches/{user1_user2}` が削除される
- user2 のウォッチャー数が減少

#### テストケース 3.1.3: 自分自身のウォッチ試行
**テスト手順:**
1. 自分のプロフィールページにアクセス

**期待結果:**
- ウォッチボタンは表示されない

#### テストケース 3.1.4: フレンドとウォッチの併用
**前提条件:**
- user1 と user2 がフレンド関係

**テスト手順:**
1. user1 で user2 をウォッチ
2. フレンド一覧とウォッチ一覧を確認

**期待結果:**
- フレンド関係とウォッチ関係は独立して機能
- user2 は両方の一覧に表示される可能性あり（仕様による）

---

## 4. フレンド一覧機能

### 4.1 フレンド一覧表示のテスト

#### テストケース 4.1.1: 自分のフレンド一覧表示
**前提条件:**
- user1 が5人とフレンド関係（accepted）

**テスト手順:**
1. user1 でプロフィールページから「フレンド」タブをクリック

**期待結果:**
- 5人のフレンドがリスト表示される
- 各フレンドのアイコン、表示名、ユーザーIDが表示される
- クリックでそのユーザーのプロフィールに遷移

#### テストケース 4.1.2: 他人のフレンド一覧表示
**前提条件:**
- user1 が3人とフレンド関係
- user2 でログイン

**テスト手順:**
1. `/user/user1` にアクセス
2. 「フレンド」タブをクリック

**期待結果:**
- user1 のフレンドが表示される
- プライバシー設定により非表示の場合もあり（仕様による）

#### テストケース 4.1.3: フレンド申請一覧（受信）
**前提条件:**
- user2 が user1 へフレンド申請済み（pending）

**テスト手順:**
1. user1 で通知またはフレンド申請ページを開く

**期待結果:**
- user2 からの申請が表示される
- 「承認」「拒否」ボタンが表示される

#### テストケース 4.1.4: フレンド申請一覧（送信）
**前提条件:**
- user1 が user2 へフレンド申請済み（pending）

**テスト手順:**
1. user1 でフレンド申請ページを開く

**期待結果:**
- user2 への申請が「申請中」と表示される
- キャンセルボタンが表示される（仕様による）

---

## 5. ウォッチ一覧機能

### 5.1 ウォッチ一覧表示のテスト

#### テストケース 5.1.1: 自分がウォッチしているユーザー一覧
**前提条件:**
- user1 が4人をウォッチ中

**テスト手順:**
1. user1 でプロフィールページから「ウォッチ中」タブをクリック

**期待結果:**
- 4人のユーザーがリスト表示される
- 各ユーザーのアイコン、表示名、ユーザーIDが表示される
- 「ウォッチ中」ボタンが表示され、クリックで解除可能

#### テストケース 5.1.2: 自分をウォッチしているユーザー一覧（ウォッチャー）
**前提条件:**
- 6人が user1 をウォッチ中

**テスト手順:**
1. user1 でプロフィールページから「ウォッチャー」タブをクリック

**期待結果:**
- 6人のユーザーがリスト表示される
- 各ユーザーのプロフィールに遷移可能

#### テストケース 5.1.3: 他人のウォッチ一覧表示
**前提条件:**
- user1 が3人をウォッチ中
- user2 でログイン

**テスト手順:**
1. `/user/user1` にアクセス
2. 「ウォッチ中」タブをクリック

**期待結果:**
- user1 がウォッチしているユーザーが表示される
- プライバシー設定により非表示の場合もあり

---

## 6. ソーシャル機能のアクセス制御

### 6.1 公開範囲によるアクセステスト

#### テストケース 6.1.1: フレンド限定アルバムへのアクセス
**前提条件:**
- user1 が friends 公開範囲のアルバムを作成
- user2 が user1 のフレンド
- user3 は user1 のフレンドではない

**テスト手順:**
1. user2 でアルバムにアクセス
2. user3 でアルバムにアクセス

**期待結果:**
- 手順1: アルバムが表示される
- 手順2: 403エラーまたは「閲覧権限がありません」

#### テストケース 6.1.2: フレンド限定アルバムへの画像追加
**前提条件:**
- user1 が friends アルバムを作成
- user2 が user1 のフレンド

**テスト手順:**
1. user2 でアルバムを開く
2. 画像をアップロード

**期待結果:**
- 画像が正常にアップロードされる（仕様により可否が決まる）

---

## 7. 通知機能との連携

### 7.1 ソーシャル通知のテスト

#### テストケース 7.1.1: フレンド申請通知
**前提条件:**
- user1 から user2 へフレンド申請

**テスト手順:**
1. user2 で通知を確認

**期待結果:**
- 「user1 からフレンド申請がありました」という通知が表示される
- 通知をクリックでuser1のプロフィールに遷移

#### テストケース 7.1.2: フレンド承認通知
**前提条件:**
- user1 から user2 へ申請し、user2 が承認

**テスト手順:**
1. user1 で通知を確認

**期待結果:**
- 「user2 がフレンド申請を承認しました」という通知が表示される

#### テストケース 7.1.3: ウォッチ通知（オプション）
**前提条件:**
- user1 が user2 をウォッチ開始

**テスト手順:**
1. user2 で通知を確認

**期待結果:**
- 「user1 があなたをウォッチしました」という通知が表示される（仕様による）

---

## 8. パフォーマンステスト

### 8.1 大量データ処理のテスト

#### テストケース 8.1.1: 大量フレンドの一覧表示
**前提条件:**
- user1 が100人とフレンド関係

**テスト手順:**
1. user1 でフレンド一覧を開く
2. 読み込み時間を測定

**期待結果:**
- 初回表示が3秒以内
- ページネーションまたは無限スクロールで段階的に読み込み

#### テストケース 8.1.2: フレンド申請の同時処理
**テスト手順:**
1. 複数のブラウザで同時に user2 へフレンド申請を送信

**期待結果:**
- すべての申請が正常に処理される
- Firestore のトランザクション処理により整合性が保たれる

---

## 9. セキュリティテスト

### 9.1 アクセス制御のテスト

#### テストケース 9.1.1: Firestore Rules のテスト（フレンド）
**テスト手順:**
1. Firebase Emulator で以下のルールをテスト:
   - 自分が送信したフレンド申請のみキャンセル可能
   - 自分宛の申請のみ承認・拒否可能
   - フレンド関係は双方からのみ削除可能

**期待結果:**
- すべてのルールが正常に動作

#### テストケース 9.1.2: Firestore Rules のテスト（ウォッチ）
**テスト手順:**
1. Firebase Emulator で以下のルールをテスト:
   - 自分のウォッチのみ作成・削除可能
   - 他人のウォッチは削除不可

**期待結果:**
- すべてのルールが正常に動作

#### テストケース 9.1.3: XSS対策のテスト
**テスト手順:**
1. 表示名に `<script>alert('XSS')</script>` を設定したユーザーとフレンドになる
2. フレンド一覧を表示

**期待結果:**
- スクリプトは実行されず、テキストとして表示される

---

## テスト環境

### 必要な環境
- ブラウザ: Chrome, Firefox, Safari, Edge
- デバイス: デスクトップ、タブレット、スマートフォン
- Firebase Emulator Suite

### テストデータ

```javascript
// テストユーザー
const testUsers = [
  { uid: "user1", handle: "user1", displayName: "User One" },
  { uid: "user2", handle: "user2", displayName: "User Two" },
  { uid: "user3", handle: "user3", displayName: "User Three" }
];

// テストフレンド関係
{
  id: "user1_user2",
  from: "user1",
  to: "user2",
  status: "pending", // または "accepted"
  createdAt: new Date()
}

// テストウォッチ関係
{
  id: "user1_user2",
  watcherId: "user1",
  watchedId: "user2",
  createdAt: new Date()
}
```

---

## 自動テストの実装

### Jestテストケース例

```typescript
// lib/repos/__tests__/friendRepo.test.ts

describe('friendRepo', () => {
  describe('sendFriendRequest', () => {
    it('should send friend request', async () => {
      await sendFriendRequest('user1', 'user2');
      const request = await getFriendRequest('user1', 'user2');
      expect(request?.status).toBe('pending');
    });

    it('should prevent duplicate requests', async () => {
      await sendFriendRequest('user1', 'user2');
      await expect(
        sendFriendRequest('user1', 'user2')
      ).rejects.toThrow();
    });
  });

  describe('acceptFriendRequest', () => {
    it('should accept friend request', async () => {
      await sendFriendRequest('user1', 'user2');
      await acceptFriendRequest('user1', 'user2');
      const friendship = await getFriendship('user1', 'user2');
      expect(friendship?.status).toBe('accepted');
    });
  });

  describe('deleteFriend', () => {
    it('should delete friendship', async () => {
      await sendFriendRequest('user1', 'user2');
      await acceptFriendRequest('user1', 'user2');
      await deleteFriend('user1', 'user2');
      const friendship = await getFriendship('user1', 'user2');
      expect(friendship).toBeNull();
    });
  });
});

// lib/repos/__tests__/watchRepo.test.ts

describe('watchRepo', () => {
  describe('watchUser', () => {
    it('should watch user', async () => {
      await watchUser('user1', 'user2');
      const watch = await getWatch('user1', 'user2');
      expect(watch).toBeDefined();
    });

    it('should prevent self-watch', async () => {
      await expect(
        watchUser('user1', 'user1')
      ).rejects.toThrow();
    });
  });

  describe('unwatchUser', () => {
    it('should unwatch user', async () => {
      await watchUser('user1', 'user2');
      await unwatchUser('user1', 'user2');
      const watch = await getWatch('user1', 'user2');
      expect(watch).toBeNull();
    });
  });
});
```

---

## テスト完了チェックリスト

- [ ] フレンド申請テストが通過
- [ ] フレンド承認・拒否テストが通過
- [ ] フレンド削除テストが通過
- [ ] ウォッチ機能テストが通過
- [ ] フレンド一覧テストが通過
- [ ] ウォッチ一覧テストが通過
- [ ] アクセス制御テストが通過
- [ ] 通知連携テストが通過
- [ ] パフォーマンステストが通過
- [ ] セキュリティテストが通過
- [ ] Firebase Emulator でのテスト完了
