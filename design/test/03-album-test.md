# アルバム機能 テスト仕様書

## テスト対象
- アルバムの作成・編集・削除
- 画像のアップロード・削除
- アルバムの公開範囲設定
- アルバムの共有機能

---

## 1. アルバム作成機能

### 1.1 基本的なアルバム作成のテスト

#### テストケース 1.1.1: 新規アルバム作成（成功ケース）
**前提条件:**
- ログイン済み
- 作成済みアルバム数が4未満

**テスト手順:**
1. `/album/create` にアクセス
2. タイトルに "My First Album" を入力
3. 説明に "This is a test album" を入力
4. 公開範囲を "public" に設定
5. 「作成」ボタンをクリック

**期待結果:**
- アルバムが正常に作成される
- `/album/{albumId}` にリダイレクト
- 成功メッセージ「アルバムを作成しました」が表示
- Firestore の `albums` コレクションに新規ドキュメントが追加される

#### テストケース 1.1.2: タイトルのバリデーション
**テスト手順:**
1. `/album/create` にアクセス
2. タイトルを空白にして作成を試行
3. タイトルに101文字を入力して作成を試行

**期待結果:**
- 手順2: エラー「タイトルを入力してください」
- 手順3: エラー「100文字以内で入力してください」
- アルバムは作成されない

#### テストケース 1.1.3: 説明のバリデーション
**テスト手順:**
1. `/album/create` で説明欄に1001文字を入力
2. 作成を試行

**期待結果:**
- エラー「1000文字以内で入力してください」

#### テストケース 1.1.4: アルバム作成数の上限チェック
**前提条件:**
- 既に4つのアルバムを作成済み

**テスト手順:**
1. `/album/create` にアクセス

**期待結果:**
- エラーメッセージ「作成できるアルバムは4つまでです」
- 作成ボタンが無効化

#### テストケース 1.1.5: 未ログイン状態での作成試行
**テスト手順:**
1. ログアウト
2. `/album/create` にアクセス

**期待結果:**
- `/login` にリダイレクト

---

### 1.2 公開範囲設定のテスト

#### テストケース 1.2.1: 公開アルバムの作成
**テスト手順:**
1. 公開範囲を "public" にしてアルバム作成

**期待結果:**
- `visibility: "public"` で保存される
- 誰でもアルバムを閲覧可能

#### テストケース 1.2.2: フレンド限定アルバムの作成
**テスト手順:**
1. 公開範囲を "friends" にしてアルバム作成

**期待結果:**
- `visibility: "friends"` で保存される
- フレンドのみ閲覧可能

#### テストケース 1.2.3: 非公開アルバムの作成
**テスト手順:**
1. 公開範囲を "private" にしてアルバム作成

**期待結果:**
- `visibility: "private"` で保存される
- 本人のみ閲覧可能

---

## 2. アルバム編集機能

### 2.1 基本情報の編集テスト

#### テストケース 2.1.1: タイトルの編集
**前提条件:**
- 自分が作成したアルバムが存在

**テスト手順:**
1. アルバム詳細ページで「編集」ボタンをクリック
2. タイトルを "Updated Title" に変更
3. 保存

**期待結果:**
- タイトルが更新される
- 成功メッセージ「アルバムを更新しました」
- ページリロード後も変更が保持される

#### テストケース 2.1.2: 説明の編集
**テスト手順:**
1. 編集モードで説明を変更
2. 保存

**期待結果:**
- 説明が更新される

#### テストケース 2.1.3: 公開範囲の変更
**テスト手順:**
1. 公開アルバムを編集
2. 公開範囲を "friends" に変更
3. 保存

**期待結果:**
- 公開範囲が更新される
- 非フレンドからはアクセス不可になる

#### テストケース 2.1.4: 他人のアルバム編集試行
**前提条件:**
- user1 が作成したアルバムが存在
- user2 でログイン

**テスト手順:**
1. user2 で user1 のアルバムページにアクセス
2. 編集ボタンの有無を確認

**期待結果:**
- 編集ボタンは表示されない
- `/album/{id}/edit` に直接アクセスしても403エラーまたはリダイレクト

---

## 3. アルバム削除機能

### 3.1 削除のテスト

#### テストケース 3.1.1: アルバムの削除
**前提条件:**
- 自分が作成したアルバムが存在（画像3枚含む）

**テスト手順:**
1. アルバム詳細ページで「削除」ボタンをクリック
2. 確認ダイアログで「削除する」を選択

**期待結果:**
- アルバムが削除される
- `/user/{handle}` にリダイレクト
- Firestore の `albums/{albumId}` が削除される
- Firebase Storage の画像ファイルがすべて削除される
- 関連する `albumImages` ドキュメントもすべて削除される

#### テストケース 3.1.2: 削除のキャンセル
**テスト手順:**
1. 「削除」ボタンをクリック
2. 確認ダイアログで「キャンセル」を選択

**期待結果:**
- アルバムは削除されない
- ダイアログが閉じる

#### テストケース 3.1.3: 他人のアルバム削除試行
**テスト手順:**
1. user2 で user1 のアルバムページにアクセス
2. 削除ボタンの有無を確認

**期待結果:**
- 削除ボタンは表示されない

---

## 4. 画像アップロード機能

### 4.1 画像追加のテスト

#### テストケース 4.1.1: 1枚の画像アップロード
**前提条件:**
- アルバムが存在（画像0枚）

**テスト手順:**
1. アルバム詳細ページで「画像を追加」ボタンをクリック
2. JPEG画像（2MB）を選択
3. アップロード

**期待結果:**
- 画像がアップロードされる
- サムネイル（128px）、中サイズ（512px）、大サイズ（1024px）が自動生成される
- アルバムグリッドに画像が表示される

#### テストケース 4.1.2: 複数画像の同時アップロード
**テスト手順:**
1. 「画像を追加」で3枚の画像を同時に選択
2. アップロード

**期待結果:**
- 3枚すべてがアップロードされる
- プログレスバーが表示される
- 完了後、すべての画像が表示される

#### テストケース 4.1.3: 画像サイズ制限のテスト
**テスト手順:**
1. 6MBの画像を選択

**期待結果:**
- エラー「5MB以下の画像を選択してください」
- アップロードされない

#### テストケース 4.1.4: ファイル形式のバリデーション
**テスト手順:**
1. PNG画像を選択
2. WebP画像を選択
3. PDFファイルを選択

**期待結果:**
- 手順1,2: 正常にアップロード
- 手順3: エラー「画像ファイルを選択してください」

#### テストケース 4.1.5: 画像枚数の上限チェック
**前提条件:**
- アルバムに既に100枚の画像が存在

**テスト手順:**
1. さらに画像を追加しようとする

**期待結果:**
- エラー「アルバムには最大100枚まで追加できます」
- アップロードボタンが無効化

---

### 4.2 画像削除のテスト

#### テストケース 4.2.1: 自分の画像削除
**前提条件:**
- 自分がアップロードした画像が存在

**テスト手順:**
1. 画像をクリックして拡大表示
2. 「削除」ボタンをクリック
3. 確認ダイアログで「削除する」を選択

**期待結果:**
- 画像が削除される
- Firebase Storage から画像ファイルが削除される
- `albumImages/{imageId}` が削除される

#### テストケース 4.2.2: 他人がアップロードした画像の削除試行
**前提条件:**
- user1 が user2 のアルバムに画像をアップロード済み
- user2（アルバムオーナー）でログイン

**テスト手順:**
1. user1 がアップロードした画像の削除ボタンを確認

**期待結果:**
- user2（オーナー）には削除ボタンが表示される
- オーナーは他人の画像も削除可能

#### テストケース 4.2.3: アルバムに参加していないユーザーの画像削除試行
**テスト手順:**
1. user3（非関係者）で画像を表示
2. 削除ボタンの有無を確認

**期待結果:**
- 削除ボタンは表示されない

---

## 5. アルバム閲覧機能

### 5.1 アルバム詳細表示のテスト

#### テストケース 5.1.1: 公開アルバムの閲覧
**前提条件:**
- public アルバムが存在

**テスト手順:**
1. 未ログイン状態で `/album/{albumId}` にアクセス

**期待結果:**
- アルバムタイトル、説明、画像グリッドが表示される
- 編集・削除ボタンは非表示

#### テストケース 5.1.2: フレンド限定アルバムの閲覧
**前提条件:**
- user1 が friends アルバムを作成
- user2 が user1 のフレンド

**テスト手順:**
1. user2 で `/album/{albumId}` にアクセス

**期待結果:**
- アルバムが表示される

#### テストケース 5.1.3: 非フレンドによるフレンド限定アルバムのアクセス試行
**前提条件:**
- user1 が friends アルバムを作成
- user3 は user1 のフレンドではない

**テスト手順:**
1. user3 で `/album/{albumId}` にアクセス

**期待結果:**
- 403エラーまたは「このアルバムは閲覧できません」
- アルバム内容は表示されない

#### テストケース 5.1.4: 非公開アルバムのアクセス制御
**前提条件:**
- user1 が private アルバムを作成

**テスト手順:**
1. user2 で `/album/{albumId}` にアクセス

**期待結果:**
- 403エラーまたは「このアルバムは閲覧できません」

---

### 5.2 画像表示のテスト

#### テストケース 5.2.1: 画像グリッドの表示
**前提条件:**
- アルバムに20枚の画像が存在

**テスト手順:**
1. アルバム詳細ページを開く

**期待結果:**
- すべての画像がグリッドレイアウトで表示される
- サムネイル（128px）が使用される

#### テストケース 5.2.2: 画像の拡大表示
**テスト手順:**
1. グリッド内の画像をクリック

**期待結果:**
- ライトボックスで画像が拡大表示される
- 大サイズ（1024px）が読み込まれる
- 左右矢印で次の画像に移動可能
- ESCキーで閉じる

#### テストケース 5.2.3: 画像の遅延読み込み
**前提条件:**
- アルバムに100枚の画像が存在

**テスト手順:**
1. アルバムを開く
2. スクロールして下部の画像を確認

**期待結果:**
- 画面外の画像は最初読み込まれない
- スクロールに応じて画像が読み込まれる（Intersection Observer使用）

---

## 6. アルバム検索・フィルタリング

### 6.1 自分のアルバム一覧のテスト

#### テストケース 6.1.1: プロフィールページでのアルバム一覧表示
**前提条件:**
- user1 が4つのアルバムを作成

**テスト手順:**
1. `/user/user1` にアクセス
2. 「作成アルバム」タブを開く

**期待結果:**
- 4つのアルバムカードが表示される
- 各カードにタイトル、サムネイル、作成日が表示される

#### テストケース 6.1.2: 公開範囲によるフィルタリング
**前提条件:**
- user1 が public 2つ、friends 1つ、private 1つのアルバムを作成
- user2（非フレンド）でアクセス

**テスト手順:**
1. user2 で `/user/user1` にアクセス
2. 「作成アルバム」タブを開く

**期待結果:**
- public の2つのみ表示される
- friends と private のアルバムは非表示

---

## 7. 共有機能のテスト

### 7.1 アルバム共有のテスト

#### テストケース 7.1.1: URLコピー機能
**テスト手順:**
1. アルバム詳細ページで「共有」ボタンをクリック
2. URLコピーボタンをクリック

**期待結果:**
- クリップボードに `/album/{albumId}` のURLがコピーされる
- 成功メッセージ「URLをコピーしました」

#### テストケース 7.1.2: SNSシェアボタン
**テスト手順:**
1. 「共有」ボタンをクリック
2. Twitterシェアボタンをクリック

**期待結果:**
- 新しいタブでTwitterのシェア画面が開く
- アルバムタイトルとURLが含まれる

---

## 8. パフォーマンステスト

### 8.1 大量データ処理のテスト

#### テストケース 8.1.1: 100枚の画像を持つアルバムの表示速度
**前提条件:**
- アルバムに100枚の画像が存在

**テスト手順:**
1. アルバム詳細ページを開く
2. 読み込み時間を測定

**期待結果:**
- 初回表示が3秒以内
- 遅延読み込みにより、画面外の画像は読み込まれない

#### テストケース 8.1.2: 画像アップロードの同時処理
**テスト手順:**
1. 10枚の画像を同時に選択してアップロード

**期待結果:**
- すべての画像が正常にアップロードされる
- プログレスバーが各画像の進捗を表示
- 失敗した画像がある場合はエラーメッセージ

---

## 9. セキュリティテスト

### 9.1 アクセス制御のテスト

#### テストケース 9.1.1: Firestore Rulesのテスト
**テスト手順:**
1. Firebase Emulator で以下のルールをテスト
   - 自分のアルバムのみ編集・削除可能
   - 公開範囲に応じた閲覧制限

**期待結果:**
- すべてのルールが正常に動作

#### テストケース 9.1.2: XSS対策のテスト
**テスト手順:**
1. アルバムタイトルに `<script>alert('XSS')</script>` を入力
2. 保存して表示

**期待結果:**
- スクリプトは実行されず、テキストとして表示される

#### テストケース 9.1.3: SQL Injection対策のテスト
**テスト手順:**
1. アルバムタイトルに `'; DROP TABLE albums; --` を入力

**期待結果:**
- 通常のテキストとして保存される
- Firestore使用のため影響なし

---

## テスト環境

### 必要な環境
- ブラウザ: Chrome, Firefox, Safari, Edge
- デバイス: デスクトップ、タブレット、スマートフォン
- Firebase Emulator Suite
- テスト用Firebase Storage

### テストデータ

```javascript
// テストアルバム
{
  id: "test-album-1",
  title: "Test Album",
  description: "This is a test album",
  visibility: "public",
  ownerId: "test-uid-1",
  createdAt: new Date(),
  updatedAt: new Date()
}

// テスト画像
{
  id: "test-image-1",
  albumId: "test-album-1",
  userId: "test-uid-1",
  originalURL: "https://storage.googleapis.com/.../original.jpg",
  thumbnailURL: "https://storage.googleapis.com/.../thumb_128.jpg",
  mediumURL: "https://storage.googleapis.com/.../medium_512.jpg",
  largeURL: "https://storage.googleapis.com/.../large_1024.jpg",
  createdAt: new Date()
}
```

---

## 自動テストの実装

### Jestテストケース例

```typescript
// lib/repos/__tests__/albumRepo.test.ts

describe('albumRepo', () => {
  describe('createAlbum', () => {
    it('should create album successfully', async () => {
      const albumData = {
        title: 'Test Album',
        description: 'Test',
        visibility: 'public' as const
      };
      const albumId = await createAlbum('test-uid', albumData);
      expect(albumId).toBeDefined();
    });

    it('should reject when user has 4 albums', async () => {
      // Create 4 albums
      for (let i = 0; i < 4; i++) {
        await createAlbum('test-uid', { title: `Album ${i}`, visibility: 'public' });
      }
      // Try to create 5th
      await expect(
        createAlbum('test-uid', { title: 'Album 5', visibility: 'public' })
      ).rejects.toThrow('作成できるアルバムは4つまでです');
    });
  });

  describe('deleteAlbum', () => {
    it('should delete album and related images', async () => {
      const albumId = await createAlbum('test-uid', { title: 'Test' });
      await deleteAlbum(albumId, 'test-uid');
      const album = await getAlbum(albumId);
      expect(album).toBeNull();
    });
  });

  describe('uploadImage', () => {
    it('should upload image and create thumbnails', async () => {
      const file = new File(['image'], 'test.jpg', { type: 'image/jpeg' });
      const imageId = await uploadAlbumImage('album-id', 'test-uid', file);
      expect(imageId).toBeDefined();
    });

    it('should reject files over 5MB', async () => {
      const largeFile = new File([new ArrayBuffer(6 * 1024 * 1024)], 'large.jpg');
      await expect(
        uploadAlbumImage('album-id', 'test-uid', largeFile)
      ).rejects.toThrow('5MB以下の画像を選択してください');
    });
  });
});
```

---

## テスト完了チェックリスト

- [ ] アルバム作成テストが通過
- [ ] アルバム編集テストが通過
- [ ] アルバム削除テストが通過
- [ ] 画像アップロードテストが通過
- [ ] 画像削除テストが通過
- [ ] アクセス制御テストが通過
- [ ] パフォーマンステストが通過
- [ ] セキュリティテストが通過
- [ ] レスポンシブデザインテストが通過
- [ ] Firebase Emulator でのテスト完了
